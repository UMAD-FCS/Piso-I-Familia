---
title: '**<br /> <br /> Familia y composición de los hogares**'
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float: yes
    smooth_scroll: yes
    toc_depth: 2
    number_sections: false 
    css: "www/estilo.css"
  pdf_document:
    toc: yes
    toc_depth: '2'
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r}
htmltools::img(src = knitr::image_uri("www/logo_umad.png"), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:15px;max-width: 45%;')

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(dplyr))


base        <- readxl::read_excel("Data/Base motor_familia.xls")
#base        <- readxl::read_excel("Bases/Data_Umad/Base_Motor_familia_12122022.xlsx")
base_fichas <- readxl::read_excel("Data/Fichas_Familia.xls")
base_fichas <- base_fichas[order(base_fichas$ID),]

```

<br />

<div style="text-align: justify">
**La [Unidad de Métodos y Acceso a Datos](https://umad.cienciassociales.edu.uy/) (UMAD) (FCS-UdelaR) a partir del [Observatorio Uruguay](https://umad.cienciassociales.edu.uy/observatorio-uruguay/) busca aportar a la difusión de conocimiento respecto a temas de interés general sobre la realidad social, económica y política del Uruguay. Esta serie de documentos tiene como objetivo presentar indicadores clave para el análisis de tendencias históricas del país que esperamos sean de utilidad para las comunidades académicas, los tomadores de decisión y los formadores de opinión, así como el público en general. Se presentan aquí indicadores sobre familia y composición de los hogares en el Uruguay durante las últimas décadas.** 

</div>

<hr style="border:1.5px solid #2c3e50"> </hr>

<br />

# **Composición y estructura de los hogares** 

## **Tipo de hogar**

<div style="text-align: justify">

Siguiendo la definición del Instituto Nacional de Estadística, el concepto de hogar particular alude a la persona o conjunto de personas, unidas o no por relaciones de parentesco, que residen en una misma vivienda y comparten, al menos, los gastos de alimentación. Por su parte, la definición de familia refiere al conjunto de personas que conforma un hogar y en que al menos dos de sus integrantes tienen una relación de parentesco y/o consanguinidad. 
A través del análisis de los hogares es posible aproximarse a la noción de familia, resultando relevante comprender la composición del hogar y los procesos y dinámicas que se producen en los mismos.
		
</div>

<br />


<div style="text-align: justify">

La clasificación de los hogares según el tipo refleja la composición de los hogares según la relación de parentesco de sus integrantes. 

* Hogar unipersonal: integrado por una sola persona. 
* Hogar biparental con hijos: integrado por el padre y la madre (pareja unida o casada legalmente) y uno o más hijos. 
* Pareja sin hijos: integrado por la pareja unida o casada legalmente sin hijos. 
* Hogar monoparental femenino: integrado por la madre y uno o más hijos. 
* Hogar monoparental masculino: integrado por el padre y uno o más hijos. 
* Hogar extendido o compuesto con núcleo monoparental: constituido por un hogar monoparental que incluyen uno o más parientes o no parientes del jefe de hogar. 
* Hogar extendido o compuesto con núcleo biparental: constituido por un hogar con núcleo biparental que incluyen uno o más parientes o no parientes del jefe de hogar.
* Hogar sin núcleo: integrado por individuos no emparentados entre ellos.

En 2021 se observa que 36,9% de los hogares están compuestos por una pareja con hijos/as, 17,5% son unipersonales, 18,9% compuestos por una preja sin hijos/as y 11,8% son monoparentales femeninos. En una menor proporción se encuentran los otros tipos de hogares. 

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 500,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares según tipo de hogar**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon","indianred2", "indianred"), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)"|
                     NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", , EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  rename(ANIO = FECHA) %>%
  rename(TIPO_HOGAR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","TIPO_HOGAR","ANIO","VALOR")]
         t1 <- t1[order(t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 500,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")

```
> **Definición:** `r def_formatted`

```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```

> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)

#Tipo de hogar

sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))


sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()


#Constuyendo tipo de hogar#

#1.UNIPERSONAL 
#2. PAREJA SIN HIJOS
#3. BIPARENTAL 
#4. MONOPARENTAL FEMENINO 
#5. MONOPARENTAL MASCULINO 
#6. EXTENDIDO O COMPUESTO 
#7. EXTENDIDO O COMPUESTO CON NÚCLEO MONOPARENTAL
#8. SIN NÚCLEO CONYUGAL

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar = case_when(sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                      sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                      (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                      (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                      (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                      (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem1 <- mutate_at(sem1, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar = case_when (sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                                       sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                                       (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                                       (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                                       (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                                       (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem2_implant <- mutate_at(sem2_implant, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))





# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de los hogares según tipo de hogar

## Total país

sem1_h_svy_1 <- sem1_h_svy %>%
  filter(tipo_hogar>0)
sem2_implant_h_svy_1 <- sem2_implant_h_svy %>%
  filter(tipo_hogar>0)

var_int <- c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5", "tipo_hogar6", "tipo_hogar7", "tipo_hogar8")
a_sem <- sapply(sem1_h_svy_1$variables %>% select(var_int), function(x){
  sem1_h_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_h_svy_1$variables %>% select(var_int), function(x){
  sem2_implant_h_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano <- matrix(,8,1)
for (i in 1:8) {
  c_ano[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}

rownames(c_ano) <- c("Unipersonal",
                     "Pareja sin hijos",
                     "Biparental",
                     "Monoparental femenino",
                     "Monoparental masculino",
                     "Extendido o compuesto",
                     "Extendido con núcleo monoparental",
                     "Sin núcleo")
colnames(c_ano)<- c("Total")
estimacion2021 <- c_ano

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />






<div style="text-align: justify">

Al analizar la distribución de los hogares según quintil de ingresos se encuentran diferencias marcadas. Es posible observar que a medida que aumentan los ingresos de los hogares aumenta el porcentaje de hogares unipersonales y de pareja sin hijos, mientras disminuye el porcentaje de hogares biparentales, monoparentales femeninos y extendidos o compuestos (con o sin núcleo monoparental).  

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 500,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
periodo <- c(max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares según tipo de hogar, por quintil de ingresos**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), , EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  ggplot(aes(x = QUINTIL, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon","indianred2", "indianred"), guide = "none"
  ) +
  #  ylim(0, 100) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de los hogares según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  rename(TIPO_HOGAR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","TIPO_HOGAR","QUINTIL","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 500,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Ingresos
sem1 <- sem1 %>% dplyr::mutate(y_pc       =  HT11 / ht19 )                      #Ingreso per-cápita
sem1 <- sem1 %>% dplyr::mutate(y_pc_svl   =  (HT11 - HT13) / ht19)              #Ingreso per-cápita sin valor locativo

sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc       =  ht11 / ht19 )                      #Ingreso per-cápita
sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc_svl   =  (ht11 - ht13) / ht19)              #Ingreso per-cápita sin valor locativo

# Quintil de ingresos
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = pesomen))
sem1_h <- sem1_h[,c("numero","quintilesy")]
sem1 <- merge(sem1, sem1_h, by = "numero")

sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = w_sem))
sem2_h <- sem2_h[,c("ID","quintilesy")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")   

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)

#Tipo de hogar

sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))


sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()


#Constuyendo tipo de hogar#

#1.UNIPERSONAL 
#2. PAREJA SIN HIJOS
#3. BIPARENTAL 
#4. MONOPARENTAL FEMENINO 
#5. MONOPARENTAL MASCULINO 
#6. EXTENDIDO O COMPUESTO 
#7. EXTENDIDO O COMPUESTO CON NÚCLEO MONOPARENTAL
#8. SIN NÚCLEO CONYUGAL

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar = case_when(sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                      sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                      (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                      (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                      (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                      (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem1 <- mutate_at(sem1, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar = case_when (sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                                       sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                                       (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                                       (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                                       (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                                       (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem2_implant <- mutate_at(sem2_implant, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))





# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de los hogares según tipo de hogar

## Total país

sem1_h_svy_1 <- sem1_h_svy %>%
  filter(tipo_hogar>0)
sem2_implant_h_svy_1 <- sem2_implant_h_svy %>%
  filter(tipo_hogar>0)

var_int <- c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5", "tipo_hogar6", "tipo_hogar7", "tipo_hogar8")
# Quintil de ingreso del hogar
a_quintil <- function(y) {
  base <- subset(sem1_h_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

a_e_quintil = matrix(, nrow = 8, ncol = 5)

for(i in 1:5){
  a_e_quintil[,i] <- a_quintil(y = i)
}

b_quintil <- function(y) {
  base <- subset(sem2_implant_h_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

b_e_quintil = matrix(, nrow = 8, ncol = 5)

for(i in 1:5){
  b_e_quintil[,i] <- b_quintil(y = i)
}

c_quintil <- as.data.frame(cbind(a_e_quintil, b_e_quintil))
c_quintil <- c_quintil %>% dplyr::mutate(m_quintil = (a_e_quintil + b_e_quintil)/2)
c_quintil <- c_quintil[,c("m_quintil")]
rownames(c_quintil) <- c("Unipersonal",
                     "Pareja sin hijos",
                     "Biparental",
                     "Monoparental femenino",
                     "Monoparental masculino",
                     "Extendido o compuesto",
                     "Extendido con núcleo monoparental",
                     "Sin núcleo")
colnames(c_quintil)<- c("Quintil 1",
                        "Quintil 2",
                        "Quintil 3",
                        "Quintil 4",
                        "Quintil 5")
estimacion2021 <- c_quintil

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```



## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />





<div style="text-align: justify">
En el siguiente gráfico puede observarse que en 2021 la mayoría de hogares en los que residen menores de 18 años son biparentales (67%), seguido de hogares monoparentales femeninos (15%) y de extendidos o compuestos (7%). 

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 501,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de hogares con menores de 18 años según tipo de hogar **
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon","indianred2", "indianred"), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  rename(ANIO = FECHA) %>%
  rename(TIPO_HOGAR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","TIPO_HOGAR","ANIO","VALOR")]
         t1 <- t1[order(t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 501,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


#Tipo de hogar

sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))


sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()


#Constuyendo tipo de hogar#

#1.UNIPERSONAL 
#2. PAREJA SIN HIJOS
#3. BIPARENTAL 
#4. MONOPARENTAL FEMENINO 
#5. MONOPARENTAL MASCULINO 
#6. EXTENDIDO O COMPUESTO 
#7. EXTENDIDO O COMPUESTO CON NÚCLEO MONOPARENTAL
#8. SIN NÚCLEO CONYUGAL

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar = case_when(sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                      sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                      (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                      (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                      (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                      (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem1 <- mutate_at(sem1, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar = case_when (sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                                       sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                                       (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                                       (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                                       (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                                       (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem2_implant <- mutate_at(sem2_implant, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))


# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)


sem1 <- sem1 %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases menores de 18 ###                                
sem1_men <- sem1 %>%  filter(men18h >0)
sem2_men <- sem2_implant %>%  filter(men18h >0)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)

sem1_h_men <- sem1_men %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h_men <- sem2_men %>% distinct(ID, .keep_all = TRUE)



### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)
sem1_h_men_svy         <- srvyr::as_survey_design(sem1_h_men, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)
sem2_implant_h_men_svy <- srvyr::as_survey_design(sem2_implant_h_men, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de hogares con menores según tipo de hogar

## Total país

sem1_h_men_svy_1 <- sem1_h_men_svy %>%
  filter(tipo_hogar>0)
sem2_implant_h_men_svy_1 <- sem2_implant_h_men_svy %>%
  filter(tipo_hogar>0)


# Total

var_int <- c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5", "tipo_hogar6", "tipo_hogar7", "tipo_hogar8")
a_sem <- sapply(sem1_h_men_svy_1$variables %>% select(var_int), function(x){
  sem1_h_men_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_h_men_svy_1$variables %>% select(var_int), function(x){
  sem2_implant_h_men_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano <- matrix(,8,1)
for (i in 1:8) {
  c_ano[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}

rownames(c_ano) <- c("Unipersonal",
                     "Pareja sin hijos",
                     "Biparental",
                     "Monoparental femenino",
                     "Monoparental masculino",
                     "Extendido o compuesto",
                     "Extendido con núcleo monoparental",
                     "Sin núcleo")
colnames(c_ano)<- c("Total")
estimacion2021 <- c_ano


```
## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />




<div style="text-align: justify">

Al analizar la distribución de los hogares con menores de 18 años según quintil de ingresos se encuentran algunas diferencias a destacar. Es posible observar que a medida que aumentan los ingresos de los hogares aumenta el porcentaje de hogares biparentales, pasando de 58% en los hogares del Quintil 1 a 83% en los del Quintil 5. Por su parte, los hogares monoparentales femeninos y los extendidos o compuestos (con o sin núcleo monoparental) disminuyen su porcentaje a medida que aumenta el quintil de ingresos.  

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 501,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
periodo <- c(max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares con menores de 18 años según tipo de hogar, por quintil de ingresos**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  ggplot(aes(x = QUINTIL, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon","indianred2", "indianred"), guide = "none"
  ) +
  #  ylim(0, 100) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  rename(TIPO_HOGAR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","TIPO_HOGAR","QUINTIL","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 501,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Ingresos
sem1 <- sem1 %>% dplyr::mutate(y_pc       =  HT11 / ht19 )                      #Ingreso per-cápita
sem1 <- sem1 %>% dplyr::mutate(y_pc_svl   =  (HT11 - HT13) / ht19)              #Ingreso per-cápita sin valor locativo

sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc       =  ht11 / ht19 )                      #Ingreso per-cápita
sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc_svl   =  (ht11 - ht13) / ht19)              #Ingreso per-cápita sin valor locativo

# Quintil de ingresos
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = pesomen))
sem1_h <- sem1_h[,c("numero","quintilesy")]
sem1 <- merge(sem1, sem1_h, by = "numero")

sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = w_sem))
sem2_h <- sem2_h[,c("ID","quintilesy")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")   

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


#Tipo de hogar

sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))


sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()


#Constuyendo tipo de hogar#

#1.UNIPERSONAL 
#2. PAREJA SIN HIJOS
#3. BIPARENTAL 
#4. MONOPARENTAL FEMENINO 
#5. MONOPARENTAL MASCULINO 
#6. EXTENDIDO O COMPUESTO 
#7. EXTENDIDO O COMPUESTO CON NÚCLEO MONOPARENTAL
#8. SIN NÚCLEO CONYUGAL

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar = case_when(sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                      sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                      (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                      (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                      (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                      (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem1 <- mutate_at(sem1, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar = case_when (sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                                       sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                                       (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                                       (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                                       (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                                       (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem2_implant <- mutate_at(sem2_implant, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))


sem1 <- sem1 %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases menores de 18 ###                                
sem1_men <- sem1 %>%  filter(men18h >0)
sem2_men <- sem2_implant %>%  filter(men18h >0)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)

sem1_h_men <- sem1_men %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h_men <- sem2_men %>% distinct(ID, .keep_all = TRUE)



### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)
sem1_h_men_svy         <- srvyr::as_survey_design(sem1_h_men, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)
sem2_implant_h_men_svy <- srvyr::as_survey_design(sem2_implant_h_men, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de hogares con menores según tipo de hogar

## Total país

sem1_h_men_svy_1 <- sem1_h_men_svy %>%
  filter(tipo_hogar>0)
sem2_implant_h_men_svy_1 <- sem2_implant_h_men_svy %>%
  filter(tipo_hogar>0)


# Total

var_int <- c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5", "tipo_hogar6", "tipo_hogar7", "tipo_hogar8")
# Quintil de ingreso del hogar
a_quintil <- function(y) {
  base <- subset(sem1_h_men_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

a_e_quintil = matrix(, nrow = 8, ncol = 5)

for(i in 1:5){
  a_e_quintil[,i] <- a_quintil(y = i)
}

b_quintil <- function(y) {
  base <- subset(sem2_implant_h_men_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

b_e_quintil = matrix(, nrow = 8, ncol = 5)

for(i in 1:5){
  b_e_quintil[,i] <- b_quintil(y = i)
}

c_quintil <- as.data.frame(cbind(a_e_quintil, b_e_quintil))
c_quintil <- c_quintil %>% dplyr::mutate(m_quintil = (a_e_quintil + b_e_quintil)/2)
c_quintil <- c_quintil[,c("m_quintil")]

rownames(c_quintil) <- c("Unipersonal",
                     "Pareja sin hijos",
                     "Biparental",
                     "Monoparental femenino",
                     "Monoparental masculino",
                     "Extendido o compuesto",
                     "Extendido con núcleo monoparental",
                     "Sin núcleo")
colnames(c_quintil)<- c("Quintil 1", 
                        "Quintil 2", 
                        "Quintil 3",
                        "Quintil 4",
                        "Quintil 5")
estimacion2021 <- c_quintil

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />



<div style="text-align: justify">
En el siguiente gráfico puede observarse que en 2021 la mayoría de hogares en los que residen menores de 15 años son biparentales (69%), seguido de hogares monoparentales femeninos (14%) y de extendidos o compuestos (7%). 

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 516,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de hogares con menores de 15 años según tipo de hogar **
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon","indianred2", "indianred"), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  rename(ANIO = FECHA) %>%
  rename(TIPO_HOGAR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","TIPO_HOGAR","ANIO","VALOR")]
         t1 <- t1[order(t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 516,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


#Tipo de hogar

sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))


sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()


#Constuyendo tipo de hogar#

#1.UNIPERSONAL 
#2. PAREJA SIN HIJOS
#3. BIPARENTAL 
#4. MONOPARENTAL FEMENINO 
#5. MONOPARENTAL MASCULINO 
#6. EXTENDIDO O COMPUESTO 
#7. EXTENDIDO O COMPUESTO CON NÚCLEO MONOPARENTAL
#8. SIN NÚCLEO CONYUGAL

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar = case_when(sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                      sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                      (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                      (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                      (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                      (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem1 <- mutate_at(sem1, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar = case_when (sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                                       sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                                       (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                                       (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                                       (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                                       (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem2_implant <- mutate_at(sem2_implant, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))


###Menores de 15 
sem1 <- sem1 %>% dplyr::mutate(men15 = case_when(bc_pe3<15 ~ 1, bc_pe3>=15 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(men15 = case_when(bc_pe3<15 ~ 1, bc_pe3>=15 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(men15h=max(men15)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(men15h=max(men15)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de hogares con menores de 15 años según tipo de hogar

##Total país
sem1_h_svy_1_men <- sem1_h_svy %>%
  filter(men15h==1 & tipo_hogar>0)
sem2_implant_h_svy_1_men <- sem2_implant_h_svy %>%
  filter(men15h==1 & tipo_hogar>0)

##Total

var_int <- c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5", "tipo_hogar6", "tipo_hogar7", "tipo_hogar8")
a_sem <- sapply(sem1_h_svy_1_men$variables %>% select(var_int), function(x){
  sem1_h_svy_1_men %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_h_svy_1_men$variables %>% select(var_int), function(x){
  sem2_implant_h_svy_1_men %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano <- matrix(,8,1)
for (i in 1:8) {
  c_ano[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}

rownames(c_ano) <- c("Unipersonal",
                     "Pareja sin hijos",
                     "Biparental",
                     "Monoparental femenino",
                     "Monoparental masculino",
                     "Extendido o compuesto",
                     "Extendido con núcleo monoparental",
                     "Sin núcleo")
colnames(c_ano)<- c("Total")
estimacion2021 <- c_ano

```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />


<div style="text-align: justify">

Al analizar la distribución de los hogares con menores de 15 años según quintil de ingresos se encuentran algunas diferencias a destacar. Es posible observar que a medida que aumentan los ingresos de los hogares aumenta el porcentaje de hogares biparentales, pasando de 59% en los hogares del Quintil 1 a 83% en los del Quintil 5. Por su parte, los hogares monoparentales femeninos y los extendidos o compuestos (con o sin núcleo monoparental) disminuyen su porcentaje a medida que aumenta el quintil de ingresos.  

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 500,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
periodo <- c(max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares con menores de 15 años según tipo de hogar, por quintil de ingresos**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  ggplot(aes(x = QUINTIL, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon","indianred2", "indianred"), guide = "none"
  ) +
  #  ylim(0, 100) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)"|
                  NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)"), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Unipersonal)" ~ "Unipersonal",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Pareja sin hijos)" ~ "Pareja sin hijos",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Biparental)" ~ "Biparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental femenino)" ~ "Monoparental femenino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Monoparental masculino)" ~ "Monoparental masculino",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido o compuesto)" ~ "Extendido o compuesto",
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Extendido con núcleo monoparental)" ~ "Extendido con núcleo monoparental" ,
    NOMINDICADOR =="Distribución porcentual de hogares con menores de 15 años según tipo de hogar (Sin núcleo)" ~ "Sin núcleo"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unipersonal", "Pareja sin hijos", "Biparental","Monoparental femenino", "Monoparental masculino", "Extendido o compuesto", "Extendido con núcleo monoparental", "Sin núcleo")))  %>%
  mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  rename(TIPO_HOGAR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","TIPO_HOGAR","QUINTIL","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 516,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Ingresos
sem1 <- sem1 %>% dplyr::mutate(y_pc       =  HT11 / ht19 )                      #Ingreso per-cápita
sem1 <- sem1 %>% dplyr::mutate(y_pc_svl   =  (HT11 - HT13) / ht19)              #Ingreso per-cápita sin valor locativo

sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc       =  ht11 / ht19 )                      #Ingreso per-cápita
sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc_svl   =  (ht11 - ht13) / ht19)              #Ingreso per-cápita sin valor locativo

# Quintil de ingresos
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = pesomen))
sem1_h <- sem1_h[,c("numero","quintilesy")]
sem1 <- merge(sem1, sem1_h, by = "numero")

sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = w_sem))
sem2_h <- sem2_h[,c("ID","quintilesy")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")   

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


#Tipo de hogar

sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(bc_pe4==1 ~ 1, bc_pe4!=1 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(hijos = case_when(bc_pe4==3 ~ 1, bc_pe4!=3 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_pariente = case_when(bc_pe4==4|bc_pe4==5 ~ 1, bc_pe4!=4&bc_pe4!=5 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(otro_nopariente = case_when(bc_pe4==6 ~ 1, bc_pe4!=6 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(servicio_domestico = case_when(bc_pe4==7 ~ 1, bc_pe4!=7 ~ 0))

sem1 <- sem1 %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefatura_femenina = case_when(bc_pe4==1&bc_pe2==2 ~ 1, bc_pe4!=1|bc_pe2!=2 ~ 0))


sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumhijo=sum(hijos)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumotro_pariente=sum(otro_pariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumno_pariente=sum(otro_nopariente)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumservicio_domestico=sum(servicio_domestico)) %>% as.data.frame()

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefatura_femenina=sum(jefatura_femenina)) %>% as.data.frame()


#Constuyendo tipo de hogar#

#1.UNIPERSONAL 
#2. PAREJA SIN HIJOS
#3. BIPARENTAL 
#4. MONOPARENTAL FEMENINO 
#5. MONOPARENTAL MASCULINO 
#6. EXTENDIDO O COMPUESTO 
#7. EXTENDIDO O COMPUESTO CON NÚCLEO MONOPARENTAL
#8. SIN NÚCLEO CONYUGAL

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar = case_when(sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                      sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                      (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                      sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                      (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                      (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                      (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem1 <- sem1 %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem1 <- sem1 %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem1 <- mutate_at(sem1, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar = case_when (sumesposo_companero==0 & sumhijo==0 & sumno_pariente==0 & sumotro_pariente==0 ~ 1, 
                                                                       sumesposo_companero>=1 & sumhijo==0 & sumotro_pariente==0 & sumno_pariente==0 ~ 2, 
                                                                       (sumesposo_companero>=1 & sumhijo>=1)& sumotro_pariente==0 & sumno_pariente==0 ~ 3, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==1 & sumno_pariente==0 ~ 4, 
                                                                       sumesposo_companero==0 & sumhijo>=1 & sumotro_pariente==0 & sumjefatura_femenina==0 & sumno_pariente==0 ~ 5, 
                                                                       (sumotro_pariente>=1 | sumno_pariente>=1)&sumjefatura_femenina==0 ~ 6, 
                                                                       (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumotro_pariente>=1) | (sumesposo_companero==0 &sumhijo>0&sumjefatura_femenina==1&sumno_pariente>=1) ~ 7,
                                                                       (sumotro_pariente >=1 | sumno_pariente >=1) & (sumesposo_companero==0 & sumhijo==0) ~ 8))

sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar1 = case_when(tipo_hogar==1 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar2 = case_when(tipo_hogar==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar3 = case_when(tipo_hogar==3 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar4 = case_when(tipo_hogar==4 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar5 = case_when(tipo_hogar==5 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar6 = case_when(tipo_hogar==6 ~ 1)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar7 = case_when(tipo_hogar==7 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(tipo_hogar8 = case_when(tipo_hogar==8 ~ 1))
sem2_implant <- mutate_at(sem2_implant, c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5","tipo_hogar6", "tipo_hogar7", "tipo_hogar8"), ~replace(., is.na(.), 0))


###Menores de 15 
sem1 <- sem1 %>% dplyr::mutate(men15 = case_when(bc_pe3<15 ~ 1, bc_pe3>=15 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(men15 = case_when(bc_pe3<15 ~ 1, bc_pe3>=15 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(men15h=max(men15)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(men15h=max(men15)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de hogares con menores de 15 años según tipo de hogar y quintil de ingresos

##Total país
sem1_h_men_svy_1 <- sem1_h_svy %>%
  filter(men15h==1 & tipo_hogar>0)
sem2_implant_h_men_svy_1 <- sem2_implant_h_svy %>%
  filter(men15h==1 & tipo_hogar>0)

# Total

var_int <- c("tipo_hogar1", "tipo_hogar2", "tipo_hogar3", "tipo_hogar4", "tipo_hogar5", "tipo_hogar6", "tipo_hogar7", "tipo_hogar8")
# Quintil de ingreso del hogar
a_quintil <- function(y) {
  base <- subset(sem1_h_men_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

a_e_quintil = matrix(, nrow = 8, ncol = 5)

for(i in 1:5){
  a_e_quintil[,i] <- a_quintil(y = i)
}

b_quintil <- function(y) {
  base <- subset(sem2_implant_h_men_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

b_e_quintil = matrix(, nrow = 8, ncol = 5)

for(i in 1:5){
  b_e_quintil[,i] <- b_quintil(y = i)
}

c_quintil <- as.data.frame(cbind(a_e_quintil, b_e_quintil))
c_quintil <- c_quintil %>% dplyr::mutate(m_quintil = (a_e_quintil + b_e_quintil)/2)
c_quintil <- c_quintil[,c("m_quintil")]

rownames(c_quintil) <- c("Unipersonal",
                         "Pareja sin hijos",
                         "Biparental",
                         "Monoparental femenino",
                         "Monoparental masculino",
                         "Extendido o compuesto",
                         "Extendido con núcleo monoparental",
                         "Sin núcleo")
colnames(c_quintil)<- c("Quintil 1", 
                        "Quintil 2", 
                        "Quintil 3",
                        "Quintil 4",
                        "Quintil 5")
estimacion2021 <- c_quintil

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />



## **Modelo de proveedor**


<div style="text-align: justify">
El indicador de modelo de proveedor económico en hogares biparentales, como aproximación a la división sexual del trabajo, permite conocer la extensión de la jornada de trabajo remunerado de ambos miembros de la pareja[^1].  

[^1]: Salvador y Pradere (2009) “Análisis de las trayectorias familiares y laborales desde una perspectiva de género y generaciones”, Proyecto G/INE/UNIFEM/UNFPA. 

Se definen las categorías de la siguiente manera: 

* Modelo de proveedor tradicional: pareja donde sólo el varón trabaja en el mercado laboral y la mujer es inactiva o desempleada. 
* Modelo de proveedor modificado: pareja donde ambos trabajan para el mercado pero el varón trabaja a tiempo completo y la mujer a tiempo parcial. 
* Modelo de doble carrera: pareja donde ambos trabajan remuneradamente, ambos a tiempo completo o ambos a tiempo parcial. 
* Modelo de inversión de roles: pareja donde sólo la mujer trabaja para el mercado laboral y el varón es inactivo o desocupado. 
* Modelo de inversión de roles modificado: el varón ocupado a tiempo parcial y mujer ocupada a tiempo completo. 
* Modelo residual: ambos no trabajan (desocupados o inactivos).  

A partir del gráfico es posible observar que entre 2006 y 2021 se produce una disminución del porcentaje de hogares con modelo de proveedor tradicional y, como contracara, un aumento del porcentaje de hogares con modelo de doble carrera. 

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 504,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares biparentales según modelo de proveedor económico**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)" ~ "Proveedor tradicional",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)" ~ "Proveedor modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)" ~ "Doble carrera" ,
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)" ~ "Inversión de roles",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)" ~ "Inversión de roles modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)" ~ "Residual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Proveedor tradicional", "Proveedor modificado", "Doble carrera","Inversión de roles", "Inversión de roles modificado", "Residual")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon"), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)" ~ "Proveedor tradicional",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)" ~ "Proveedor modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)" ~ "Doble carrera" ,
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)" ~ "Inversión de roles",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)" ~ "Inversión de roles modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)" ~ "Residual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Proveedor tradicional", "Proveedor modificado", "Doble carrera","Inversión de roles", "Inversión de roles modificado", "Residual")))  %>%
  rename(ANIO = FECHA) %>%
  rename(MODELO_PROVEEDOR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","MODELO_PROVEEDOR","ANIO","VALOR")]
         t1 <- t1[order(t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 504,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 


```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />







<div style="text-align: justify">

Considerando el modelo de proveedor de los hogares según el quintil de ingresos hay dos aspectos a destacar. Por un lado, el porcentaje de hogares con modelo de proveedor tradicional disminuye a medida que aumentan los ingresos de los hogares, pasando de 44,1% en los hogares del primer quintil de ingresos a 10,5% en los del quinto quintil. Del otro lado, los hogares con modelo de doble carrera aumentan el porcentaje conforme aumenta el quintil de ingresos (17,9% en el primer quintil y 35,8% en el quinto quintil).   

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 504,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
periodo <- c(max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares biparentales según modelo de proveedor económico, por quintil de ingresos**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)" ~ "Proveedor tradicional",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)" ~ "Proveedor modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)" ~ "Doble carrera" ,
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)" ~ "Inversión de roles",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)" ~ "Inversión de roles modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)" ~ "Residual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Proveedor tradicional", "Proveedor modificado", "Doble carrera","Inversión de roles", "Inversión de roles modificado", "Residual")))  %>%
    mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  ggplot(aes(x = QUINTIL, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60", "darksalmon"), guide = "none"
  ) +
  #  ylim(0, 100) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)"|
                  NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", FECHA==max(FECHA), EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
    NOMINDICADOR == "Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor tradicional)" ~ "Proveedor tradicional",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Proveedor modificado)" ~ "Proveedor modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Doble carrera)" ~ "Doble carrera" ,
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles)" ~ "Inversión de roles",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Inversión de roles modificado)" ~ "Inversión de roles modificado",
    NOMINDICADOR =="Distribución porcentual de los hogares biparentales según modelo de pareja (Residual)" ~ "Residual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Proveedor tradicional", "Proveedor modificado", "Doble carrera","Inversión de roles", "Inversión de roles modificado", "Residual")))  %>%
    mutate(QUINTIL = case_when(
    QUINTIL == "Quintil 1" ~ "Quintil 1", QUINTIL == "Quintil 2" ~ "Quintil 2", QUINTIL == "Quintil 3" ~ "Quintil 3", QUINTIL == "Quintil 4" ~ "Quintil 4", QUINTIL == "Quintil 5" ~ "Quintil 5"))  %>%
  mutate(QUINTIL = factor(QUINTIL, levels = c("Quintil 1", "Quintil 2", "Quintil 3","Quintil 4", "Quintil 5")))  %>%
  rename(MODELO_PROVEEDOR = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","MODELO_PROVEEDOR","QUINTIL","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 504,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Ingresos
sem1 <- sem1 %>% dplyr::mutate(y_pc       =  HT11 / ht19 )                      #Ingreso per-cápita
sem1 <- sem1 %>% dplyr::mutate(y_pc_svl   =  (HT11 - HT13) / ht19)              #Ingreso per-cápita sin valor locativo

sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc       =  ht11 / ht19 )                      #Ingreso per-cápita
sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc_svl   =  (ht11 - ht13) / ht19)              #Ingreso per-cápita sin valor locativo

# Quintil de ingresos
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = pesomen))
sem1_h <- sem1_h[,c("numero","quintilesy")]
sem1 <- merge(sem1, sem1_h, by = "numero")

sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = w_sem))
sem2_h <- sem2_h[,c("ID","quintilesy")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")   

### Modelo de pareja
sem1 <- sem1 %>% dplyr::mutate(bc_pobp = POBPCOAC)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pobp = pobpcoac)

sem1 <- sem1 %>% dplyr::mutate(bc_horas = F85+F98)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_horas = f85+f98)

sem1 <- sem1 %>% dplyr::mutate(bc_horas_1 = F85)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_horas_1 = f85)

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


# Relación de parentesco
sem1 <- sem1 %>% dplyr::mutate(bc_pe4 = case_when(e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                  e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe4 = case_when (e30==1 ~ 1, e30==2 ~ 2, e30 ==3|e30==4|e30==5 ~ 3, e30==6|e30==7 ~ 4, 
                                                                   e30==8|e30==9|e30==10|e30==11|e30==12 ~ 5, e30==13 ~ 6, e30==14 ~ 7))

sem1 <- sem1 %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(esposo_companero = case_when(bc_pe4==2 ~ 1, bc_pe4!=2 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumesposo_companero=sum(esposo_companero)) %>% as.data.frame()


#generamos la variable que identifica hogares en donde hay una pareja 

sem1 <- sem1 %>% dplyr::mutate(biparentales = case_when(sumesposo_companero>0 ~ 1, sumesposo_companero==0 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(biparentales = case_when(sumesposo_companero>0 ~ 1, sumesposo_companero==0 ~ 0))

#Nos quedamos solo con los hogares biparentales*


#generamos variables a nivel agregado
#Primero generamos variable a nivel personas*

#JEFE Ocupado tiempo completo_varón*
sem1 <- sem1 %>% dplyr::mutate(jefeocup_tc_v = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & jefe==1 & bc_pe2==1&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefeocup_tc_v = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & jefe==1 & bc_pe2==1&biparentales==1 ~ 1))

#JEFE Ocupado tiempo completo_mujer*
sem1 <- sem1 %>% dplyr::mutate(jefeocup_tc_m = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & jefe==1 & bc_pe2==2&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefeocup_tc_m = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & jefe==1 & bc_pe2==2&biparentales==1 ~ 1))

#CONYUGE Ocupado tiempo completo*
sem1 <- sem1 %>% dplyr::mutate(conyocup_tc_v = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & esposo_companero==1 & bc_pe2==1&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(conyocup_tc_v = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & esposo_companero==1 & bc_pe2==1&biparentales==1 ~ 1))

sem1 <- sem1 %>% dplyr::mutate(conyocup_tc_m = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & esposo_companero==1 & bc_pe2==2&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(conyocup_tc_m = case_when(bc_pobp==2 & (bc_horas>39 | bc_horas_1>39) & esposo_companero==1 & bc_pe2==2&biparentales==1 ~ 1))

#JEFE Ocupado medio tiempo_varón*
sem1 <- sem1 %>% dplyr::mutate(jefeocup_mt_v = case_when(bc_pobp==2 & bc_horas<40 & jefe==1 & bc_pe2==1&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefeocup_mt_v = case_when(bc_pobp==2 & bc_horas<40 & jefe==1 & bc_pe2==1&biparentales==1 ~ 1))

#JEFE Ocupado medio tiempo_mujer*
sem1 <- sem1 %>% dplyr::mutate(jefeocup_mt_m = case_when(bc_pobp==2 & bc_horas<40& jefe==1 & bc_pe2==2&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefeocup_mt_m = case_when(bc_pobp==2 & bc_horas<40& jefe==1 & bc_pe2==2&biparentales==1 ~ 1))

#CONYUGE Ocupado medio tiempo_varón*
sem1 <- sem1 %>% dplyr::mutate(conyocup_mt_v = case_when(bc_pobp==2 & bc_horas<40& esposo_companero==1 & bc_pe2==1&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(conyocup_mt_v = case_when(bc_pobp==2 & bc_horas<40& esposo_companero==1 & bc_pe2==1&biparentales==1 ~ 1))

#CONYUGE Ocupado medio tiempo_mujer*
sem1 <- sem1 %>% dplyr::mutate(conyocup_mt_m = case_when(bc_pobp==2 & bc_horas<40& esposo_companero==1 & bc_pe2==2&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(conyocup_mt_m = case_when(bc_pobp==2 & bc_horas<40& esposo_companero==1 & bc_pe2==2&biparentales==1 ~ 1))

#JEFE Inactivo o desempleado_varón*
sem1 <- sem1 %>% dplyr::mutate(jefeinact_desoc_v = case_when(bc_pobp>2 & bc_pobp<12 & jefe==1 & bc_pe2==1&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefeinact_desoc_v = case_when(bc_pobp>2 & bc_pobp<12 & jefe==1 & bc_pe2==1&biparentales==1 ~ 1))

#JEFE Inactivo o desempleado_mujer*
sem1 <- sem1 %>% dplyr::mutate(jefeinact_desoc_m = case_when(bc_pobp>2 & bc_pobp<12 & jefe==1 & bc_pe2==2&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefeinact_desoc_m = case_when(bc_pobp>2 & bc_pobp<12 & jefe==1 & bc_pe2==2&biparentales==1 ~ 1))

#CONYUGE Inactivo o desempleado_varón*
sem1 <- sem1 %>% dplyr::mutate(conyinact_desoc_v = case_when(bc_pobp>2 & bc_pobp<12 & esposo_companero==1 & bc_pe2==1&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(conyinact_desoc_v = case_when(bc_pobp>2 & bc_pobp<12 & esposo_companero==1 & bc_pe2==1&biparentales==1 ~ 1))

#CONYUGE Inactivo o desempleado_mujer*
sem1 <- sem1 %>% dplyr::mutate(conyinact_desoc_m = case_when(bc_pobp>2 & bc_pobp<12 & esposo_companero==1 & bc_pe2==2&biparentales==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(conyinact_desoc_m = case_when(bc_pobp>2 & bc_pobp<12 & esposo_companero==1 & bc_pe2==2&biparentales==1 ~ 1))



sem1 <- mutate_at(sem1, c("jefeocup_tc_v", "jefeocup_tc_m", "conyocup_tc_v", "conyocup_tc_m", "jefeocup_mt_v", "jefeocup_mt_m", 
                          "conyocup_mt_v", "conyocup_mt_m", "jefeinact_desoc_v", "jefeinact_desoc_m", "conyinact_desoc_v", "conyinact_desoc_m"), ~replace(., is.na(.), 0))
sem2_implant <- mutate_at(sem2_implant, c("jefeocup_tc_v", "jefeocup_tc_m", "conyocup_tc_v", "conyocup_tc_m", "jefeocup_mt_v", "jefeocup_mt_m", 
                                          "conyocup_mt_v", "conyocup_mt_m", "jefeinact_desoc_v", "jefeinact_desoc_m", "conyinact_desoc_v", "conyinact_desoc_m"), ~replace(., is.na(.), 0))


#### Segundo, variables agregadas a nivel hogar
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefeocup_tc_m=sum(jefeocup_tc_m)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefeocup_tc_v=sum(jefeocup_tc_v)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumconyocup_tc_m=sum(conyocup_tc_m)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumconyocup_tc_v=sum(conyocup_tc_v)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefeocup_mt_m=sum(jefeocup_mt_m)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefeocup_mt_v=sum(jefeocup_mt_v)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumconyocup_mt_v=sum(conyocup_mt_v)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumconyocup_mt_m=sum(conyocup_mt_m)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat)  %>% mutate(sumjefeinact_desoc_m=sum(jefeinact_desoc_m)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefeinact_desoc_v=sum(jefeinact_desoc_v)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumconyinact_desoc_m=sum(conyinact_desoc_m)) %>% as.data.frame()
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumconyinact_desoc_v=sum(conyinact_desoc_v)) %>% as.data.frame()

sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefeocup_tc_m=sum(jefeocup_tc_m)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefeocup_tc_v=sum(jefeocup_tc_v)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumconyocup_tc_m=sum(conyocup_tc_m)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumconyocup_tc_v=sum(conyocup_tc_v)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefeocup_mt_m=sum(jefeocup_mt_m)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefeocup_mt_v=sum(jefeocup_mt_v)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumconyocup_mt_v=sum(conyocup_mt_v)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumconyocup_mt_m=sum(conyocup_mt_m)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefeinact_desoc_m=sum(jefeinact_desoc_m)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefeinact_desoc_v=sum(jefeinact_desoc_v)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumconyinact_desoc_m=sum(conyinact_desoc_m)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumconyinact_desoc_v=sum(conyinact_desoc_v)) %>% as.data.frame()


#### Generamos la variable de modelos de pareja con las categorías de arriba
#1. PROVEEDOR TRADICIONAL (solo hombre trabaja, mujer inactiva o desempleada)*
#2 PROVEEDOR MODIFICADO: pareja donde ambos trabajan para el mercado pero el hombre trabaja a tiempo completo y la mujer a tiempo parcial. 
#3. DOBLE CARRERA:  pareja donde ambos trabajan para el mercado, ambos a tiempo completo o ambos a tiempo parcial. 
#4. INVERSIÓN DE ROLES: pareja donde sÓlo la mujer trabaja para el mercado y el hombre es inactivo o desocupado. 
#5. INVERSIÓN DE ROLES MODIFICADO: ambos trabajan en el mercado laboral pero hombre ocupado a tiempo parcial y mujer ocupada a tiempo completo.
#6. MODELO RESIDUAL: Ambos no trabajan (desocupados o inactivos)

sem1 <- sem1 %>% dplyr::mutate(modelo_pareja = case_when(((sumjefeocup_tc_v==1 & sumconyinact_desoc_m==1)|(sumconyocup_tc_v==1 & sumjefeinact_desoc_m==1)|(sumjefeocup_mt_v==1 & sumconyinact_desoc_m==1)|(sumconyocup_mt_v==1 & sumjefeinact_desoc_m==1))&biparentales==1 ~ 1, 
                                                         ((sumjefeocup_tc_v==1 & sumconyocup_mt_m==1) | (sumconyocup_tc_v==1 & sumjefeocup_mt_m==1))&biparentales==1 ~ 2,
                                                         ((sumjefeocup_tc_v==1 & sumconyocup_tc_m==1) | (sumjefeocup_tc_m==1 & sumconyocup_tc_v==1)| (sumjefeocup_mt_m==1 & sumconyocup_mt_v==1) | (sumjefeocup_mt_v==1 & sumconyocup_mt_m==1))&biparentales==1 ~3,
                                                         ((sumjefeocup_tc_m==1 & sumconyinact_desoc_v==1) | (sumconyocup_tc_m==1 & sumjefeinact_desoc_v==1)| (sumjefeocup_mt_m==1 & sumconyinact_desoc_v==1) | (sumconyocup_mt_m==1 & sumjefeinact_desoc_v==1))&biparentales==1 ~4,
                                                         ((sumjefeocup_tc_m==1 & sumconyocup_mt_v==1) | (sumconyocup_tc_m==1 & sumjefeocup_mt_v==1))&biparentales==1 ~ 5, 
                                                         ((sumjefeinact_desoc_m==1 & sumconyinact_desoc_v==1) | (sumjefeinact_desoc_v==1 & sumconyinact_desoc_m==1))&biparentales==1 ~6))

sem1 <- sem1 %>% dplyr::mutate(modelo_pareja1 = case_when(modelo_pareja==1 ~ 1, modelo_pareja!=1 ~ 0)) 
sem1 <- sem1 %>% dplyr::mutate(modelo_pareja2 = case_when(modelo_pareja==2 ~ 1, modelo_pareja!=2 ~ 0)) 
sem1 <- sem1 %>% dplyr::mutate(modelo_pareja3 = case_when(modelo_pareja==3 ~ 1, modelo_pareja!=3 ~ 0)) 
sem1 <- sem1 %>% dplyr::mutate(modelo_pareja4 = case_when(modelo_pareja==4 ~ 1, modelo_pareja!=4 ~ 0)) 
sem1 <- sem1 %>% dplyr::mutate(modelo_pareja5 = case_when(modelo_pareja==5 ~ 1, modelo_pareja!=5 ~ 0)) 
sem1 <- sem1 %>% dplyr::mutate(modelo_pareja6 = case_when(modelo_pareja==6 ~ 1, modelo_pareja!=6 ~ 0)) 
sem1 <- mutate_at(sem1, c("modelo_pareja1", "modelo_pareja2", "modelo_pareja3", "modelo_pareja4", "modelo_pareja5","modelo_pareja6"), ~replace(., is.na(.), 0))

sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja = case_when(((sumjefeocup_tc_v==1 & sumconyinact_desoc_m==1)|(sumconyocup_tc_v==1 & sumjefeinact_desoc_m==1)|(sumjefeocup_mt_v==1 & sumconyinact_desoc_m==1)|(sumconyocup_mt_v==1 & sumjefeinact_desoc_m==1))&biparentales==1 ~ 1, 
                                                                         ((sumjefeocup_tc_v==1 & sumconyocup_mt_m==1) | (sumconyocup_tc_v==1 & sumjefeocup_mt_m==1))&biparentales==1 ~ 2,
                                                                         ((sumjefeocup_tc_v==1 & sumconyocup_tc_m==1) | (sumjefeocup_tc_m==1 & sumconyocup_tc_v==1)| (sumjefeocup_mt_m==1 & sumconyocup_mt_v==1) | (sumjefeocup_mt_v==1 & sumconyocup_mt_m==1))&biparentales==1 ~3,
                                                                         ((sumjefeocup_tc_m==1 & sumconyinact_desoc_v==1) | (sumconyocup_tc_m==1 & sumjefeinact_desoc_v==1)| (sumjefeocup_mt_m==1 & sumconyinact_desoc_v==1) | (sumconyocup_mt_m==1 & sumjefeinact_desoc_v==1))&biparentales==1 ~4,
                                                                         ((sumjefeocup_tc_m==1 & sumconyocup_mt_v==1) | (sumconyocup_tc_m==1 & sumjefeocup_mt_v==1))&biparentales==1 ~ 5, 
                                                                         ((sumjefeinact_desoc_m==1 & sumconyinact_desoc_v==1) | (sumjefeinact_desoc_v==1 & sumconyinact_desoc_m==1))&biparentales==1 ~6))

sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja1 = case_when(modelo_pareja==1 ~ 1, modelo_pareja!=1 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja2 = case_when(modelo_pareja==2 ~ 1, modelo_pareja!=2 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja3 = case_when(modelo_pareja==3 ~ 1, modelo_pareja!=3 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja4 = case_when(modelo_pareja==4 ~ 1, modelo_pareja!=4 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja5 = case_when(modelo_pareja==5 ~ 1, modelo_pareja!=5 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(modelo_pareja6 = case_when(modelo_pareja==6 ~ 1, modelo_pareja!=6 ~ 0)) 
sem2_implant <- mutate_at(sem2_implant, c("modelo_pareja1", "modelo_pareja2", "modelo_pareja3", "modelo_pareja4", "modelo_pareja5","modelo_pareja6"), ~replace(., is.na(.), 0))


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de los hogares biparentales según modelo de pareja

## Total país

sem1_h_svy_1 <- sem1_h_svy %>%
  filter(modelo_pareja>0)
sem2_implant_h_svy_1 <- sem2_implant_h_svy %>%
  filter(modelo_pareja>0)

# Quintil de ingresos

var_int <- c("modelo_pareja1", "modelo_pareja2", "modelo_pareja3", "modelo_pareja4", "modelo_pareja5", "modelo_pareja6")
a_quintil <- function(y) {
  base <- subset(sem1_h_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

a_e_quintil = matrix(, nrow = 6, ncol = 5)

for(i in 1:5){
  a_e_quintil[,i] <- a_quintil(y = i)
}

b_quintil <- function(y) {
  base <- subset(sem2_implant_h_svy_1, quintilesy == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

b_e_quintil = matrix(, nrow = 6, ncol = 5)

for(i in 1:5){
  b_e_quintil[,i] <- b_quintil(y = i)
}

c_quintil <- as.data.frame(cbind(a_e_quintil, b_e_quintil))
c_quintil <- c_quintil %>% dplyr::mutate(m_quintil = (a_e_quintil + b_e_quintil)/2)
c_quintil <- c_quintil[,c("m_quintil")]


rownames(c_quintil) <-   c("Proveedor tradicional",
                           "Proveedor modificado",
                           "Doble carrera",
                           "Inversión de roles",
                           "Inversión de roles modificado",
                           "Residual" )

colnames(c_quintil)<- c("Quintil 1",
                        "Quintil 2",
                        "Quintil 3",
                        "Quintil 4",
                        "Quintil 5")
estimacion2021 <- c_quintil


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />



<br />


## **Estado civil**

<div style="text-align: justify">
El análisis del estado civil de las personas permite conocer aspectos vinculados a la nupcialidad, viudez, separaciones, así como dinámicas de la organización familiar. Las personas se clasifican en varias categorías: solteros, casados, unión libre, viudos, divorciados y separados.

En el siguiente gráfico se observa que mientras el porcentaje de personas solteras, divorciadas o separadas y viudas se mantiene relativamente estable en el período presentado, el porcentaje de personas casadas diminuye en 10 puntos porcentuales, mientras el porcentaje de personas en unión libre aumenta en la misma magnitud.  

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 505,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de las personas según estado conyugal**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================



g1 <- 
  base %>% filter((NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Unión libre)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Casada/o)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Divorciada/o o serparada/o)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Viuda/o)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Soltera/o)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Unión libre)" ~ "Unión libre", 
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Casada/o)" ~ "Casada/o",
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Divorciada/o o serparada/o)" ~ "Divorciada/o o separada/o",
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Viuda/o)" ~ "Viuda/o",
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Soltera/o)" ~ "Soltera/o"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unión libre", "Casada/o", "Divorciada/o o separada/o","Viuda/o", "Soltera/o")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60"), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Unión libre)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Casada/o)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Divorciada/o o serparada/o)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Viuda/o)"|
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Soltera/o)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Unión libre)" ~ "Unión libre", 
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Casada/o)" ~ "Casada/o",
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Divorciada/o o serparada/o)" ~ "Divorciada/o o separada/o",
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Viuda/o)" ~ "Viuda/o",
NOMINDICADOR =="Distribución porcentual de las personas según estado conyugal (Soltera/o)" ~ "Soltera/o"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Unión libre", "Casada/o", "Divorciada/o o separada/o","Viuda/o", "Soltera/o")))  %>%
  rename(ANIO = FECHA) %>%
  rename(ESTADO_CIVIL = UNIDAD)


         t1 <- t1 [,c("NOMINDICADOR","PAÍS","ESTADO_CIVIL","ANIO","VALOR")]
         t1 <- t1[order(t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 505,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />






<br />

## **Jefatura del hogar**

<div style="text-align: justify">
La jefatura de hogar es utilizada para identificar una persona de referencia en las Encuestas Continuas de Hogares para designar el parentesco con el resto de las personas integrantes del hogar. Ante esta pregunta, las interpretaciones que pueden dar los/as encuestados/as son diversas, resultando complejo delimitar el concepto de jefatura. A pesar de esta limitación, el análisis de la jefatura del hogar según sexo resulta un indicador relevante para aproximarnos a la organización familiar y las dinámicas de género en los hogares. 


Es posible observar que el porcentaje de hogares con jefatura femenina aumenta 17 puntos porcentuales entre 2006 y 2021, pasando de 33,2% a 50,7%. Por su parte, puede verse que en el localidades mayores a 5.000 habitantes es donde el porcentaje de hogares con jefatura femenina es mayor, seguido por las localidades menores de 5.000 habitabtes y, luego, el área rural dispersa.  

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 508,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Distribución porcentual de los hogares según sexo del jefe/a**
##### Total país, `r periodo_formatted`

</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================



g1 <- 
  base %>% filter((NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Varón)"|
NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Mujer)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Varón)"~ "Varón", 
NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Mujer)" ~ "Mujer"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Varón", "Mujer")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.6)+
  scale_fill_manual(
    values = c("darkorange", 639), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Varón)"|
NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Mujer)"), URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Varón)"~ "Varón", 
NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Mujer)" ~ "Mujer"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Varón", "Mujer")))  %>%
  rename(ANIO = FECHA) %>%
  rename(SEXO_ANT = SEXO) %>%
  rename(SEXO = UNIDAD)

         t1 <- t1 [,c("NOMINDICADOR","PAÍS","SEXO","ANIO","VALOR")]
         t1 <- t1[order(t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```

#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 508,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


# Sexo del jefe/a de hogar
sem1 <- sem1[order(sem1$numero, sem1$e30, decreasing = FALSE), ]
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & bc_pe2 == 1 ~ 1,
                                                        e30 == 1 & bc_pe2 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem1_h <- sem1_h[,c("numero","sexojefe")]
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem1 <- merge(sem1, sem1_h, by = "numero")
sem1 <- sem1 %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1 <- sem1 %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_implant <- sem2_implant[order(as.numeric(sem2_implant$ID), sem2_implant$e30, decreasing = FALSE), ]
sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & e26 == 1 ~ 1,
                                                        e30 == 1 & e26 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_h <- sem2_h[,c("ID","sexojefe")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")

sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Distribución porcentual de los hogares según sexo del jefe/a del hogar

## Total país

# Total

var_int <- c("sexojefe1", "sexojefe2")
a_sem <- sapply(sem1_h_svy$variables %>% select(var_int), function(x){
  sem1_h_svy %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_h_svy$variables %>% select(var_int), function(x){
  sem2_implant_h_svy %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano <- matrix(,2,1)
for (i in 1:2) {
  c_ano[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}


rownames(c_ano) <-    c("Varón",
                        "Mujer")

colnames(c_ano)<- c("Total")
estimacion2021 <- c_ano

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}


```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`


<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 508,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de los hogares con jefatura femenina, según región de residencia**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Mujer)"),   
FECHA>2005, SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", URBANORURALUY == "Urbano (menos de 5.000 habitantes)"|URBANORURALUY == "Urbano (más de 5.000 habitantes)"|URBANORURALUY == "Rural disperso"|URBANORURALUY == "Total país", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(
  URBANORURALUY == "Urbano (menos de 5.000 habitantes)"~"Urbano (menos de 5.000 habitantes)", URBANORURALUY == "Urbano (más de 5.000 habitantes)"~"Urbano (más de 5.000 habitantes)",URBANORURALUY == "Rural disperso"~ "Rural disperso", URBANORURALUY == "Total país"~"Todos"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Urbano (menos de 5.000 habitantes)", "Urbano (más de 5.000 habitantes)", "Rural disperso", "Todos")))  %>%
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 4, color = UNIDAD))+
 scale_color_manual(
    values = c(639, "#a1dd70","orangered","lightslategrey")
      ) +
  ylim(0, 75) +
  scale_x_continuous(breaks=seq(2006, max, 1)) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```


#### Tabla
         
         
```{r}
t1 <- 
base %>% filter((NOMINDICADOR =="Distribución porcentual de los hogares según sexo del jefe/a (Mujer)"),  
FECHA>2005, SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", URBANORURALUY == "Urbano (menos de 5.000 habitantes)"|URBANORURALUY == "Urbano (más de 5.000 habitantes)"|URBANORURALUY == "Rural disperso"|URBANORURALUY == "Total país", EDAD=="Todos", POBRE=="Todos") %>%
mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
mutate(UNIDAD = case_when(
URBANORURALUY == "Urbano (menos de 5.000 habitantes)"~"Urbano (menos de 5.000 habitantes)", URBANORURALUY == "Urbano (más de 5.000 habitantes)"~"Urbano (más de 5.000 habitantes)",URBANORURALUY == "Rural disperso"~ "Rural disperso", URBANORURALUY == "Total país"~"Todos"))  %>%
mutate(UNIDAD = factor(UNIDAD, levels = c("Urbano (menos de 5.000 habitantes)", "Urbano (más de 5.000 habitantes)", "Rural disperso", "Todos")))  %>%
rename(UNIDAD_GEOGRÁFICA = URBANORURALUY) %>%
rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","UNIDAD_GEOGRÁFICA","ANIO","VALOR")]
t1 <- t1[order(t1$ANIO, t1$UNIDAD_GEOGRÁFICA), ]
                           
DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
buttons = c('copy', 'csv', 'excel', 'print') )
) 
```



#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 508,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Región
sem1 <- sem1 %>% dplyr::mutate(bd_region = case_when(region_4 == 1 | region_4 == 2 ~ 1,
                                                     region_4 == 3 ~ 2,
                                                     region_4 == 4 ~ 3))

sem2_implant <- sem2_implant %>% dplyr::mutate(bd_region = case_when(region_4 == 1 | region_4 == 2 ~ 1,region_4 == 3 ~ 2,region_4 == 4 ~ 3))

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


# Sexo del jefe/a de hogar
sem1 <- sem1[order(sem1$numero, sem1$e30, decreasing = FALSE), ]
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & bc_pe2 == 1 ~ 1,
                                                        e30 == 1 & bc_pe2 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem1_h <- sem1_h[,c("numero","sexojefe")]
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem1 <- merge(sem1, sem1_h, by = "numero")
sem1 <- sem1 %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1 <- sem1 %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_implant <- sem2_implant[order(as.numeric(sem2_implant$ID), sem2_implant$e30, decreasing = FALSE), ]
sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & e26 == 1 ~ 1,
                                                        e30 == 1 & e26 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_h <- sem2_h[,c("ID","sexojefe")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")

sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Porcentaje de  hogares con jefatura femenina según región de residencia

## Total país
var_int <- c("sexojefe1", "sexojefe2")

a_sem <- sapply(sem1_h_svy$variables %>% select(var_int), function(x){
  sem1_h_svy %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_h_svy$variables %>% select(var_int), function(x){
  sem2_implant_h_svy %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano <- matrix(,2,1)
for (i in 1:2) {
  c_ano[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}

# Región

a_reg <- function(y) {
  base <- subset(sem1_h_svy, bd_region == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

a_e_reg = matrix(, nrow = 2, ncol = 3)

for(i in 1:3){
  a_e_reg[,i] <- a_reg(y = i)
}

b_reg <- function(y) {
  base <- subset(sem2_implant_h_svy, bd_region == y) 
  resultados  <-  sapply(base$variables %>% select(var_int), function(x){
    base %>%
      srvyr::summarise(stat1 = srvyr::survey_mean(x, na.rm = TRUE))
    
  })
  y <- as.numeric(resultados[1,])
}

b_e_reg = matrix(, nrow = 2, ncol = 3)

for(i in 1:3){
  b_e_reg[,i] <- b_reg(y = i)
}

c_reg <- as.data.frame(cbind(a_e_reg[2,1:3], b_e_reg[2,1:3]))
c_reg <- c_reg %>% dplyr::mutate(m_reg = (a_e_reg[2,1:3] + b_e_reg[2,1:3])/2)
c_reg <- c_reg[,c("m_reg")]
c_reg <- as.data.frame(c(c_reg, c_ano[2]))

colnames(c_reg) <-    c("Mujer")
rownames(c_reg)<- c("Urbano (Más de 5.000 habitantes)",
                    "Urbano (Menos de 5.000 habitantes)",
                    "Rural disperso", 
                    "Total país")
estimacion2021 <- c_reg


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```



## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />





<br />

## **Edad de integrantes**

<div style="text-align: justify">
El siguiente indicador permite conocer la composición de los hogares según las edades de sus integrantes, en particular, de niños y niñas entre 0 y 17 años, resultando relevante para conocer la carga de cuidados en los hogares, el número de personas en edad escolar, entre otros.

El porcentaje de hogares en los que residen menores entre 0 y 17 años tiene una leve disminución del orden de 2 puntos porcentuales en el período. Sin embargo, esta tendencia es más acentuada  entre los hogares con jefatura masculina a la vez que presenta un sentido contrario para aquellos con jefatura femenina. Por su parte a medida que aumenta el quintil de ingresos, disminuye el porcentaje de hogares con menores entre 0 y 17 años.

</div>
<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 512,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad, según sexo del jefe/a del hogar**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad", URBANORURALUY == "Total país", SEXO == "Todos"|SEXO=="Varones"|SEXO=="Mujeres", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  mutate(UNIDAD = case_when(
  SEXO =="Varones" ~ "Varones", SEXO == "Mujeres" ~ "Mujeres", SEXO=="Todos" ~ "Total"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Mujeres", "Varones", "Total")))  %>%
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 3, color = UNIDAD))+
  scale_color_manual(
    values = c(639, "#a1dd70", "darkorange"),
    labels = c("Varones", "Mujeres", "Total")
  ) +
  ylim(0, 60) +
  scale_x_continuous(breaks=seq(2006, max, 1), limits=c(2006,max))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad", URBANORURALUY == "Total país", SEXO == "Todos"|SEXO=="Varones"|SEXO=="Mujeres", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  mutate(UNIDAD = case_when(
  SEXO =="Varones" ~ "Varones", SEXO == "Mujeres" ~ "Mujeres", SEXO=="Todos" ~ "Total"))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","SEXO","ANIO","VALOR")]
t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 512,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)

# Sexo del jefe/a de hogar
sem1 <- sem1[order(sem1$numero, sem1$e30, decreasing = FALSE), ]
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & bc_pe2 == 1 ~ 1,
                                                        e30 == 1 & bc_pe2 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem1_h <- sem1_h[,c("numero","sexojefe")]
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem1 <- merge(sem1, sem1_h, by = "numero")
sem1 <- sem1 %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1 <- sem1 %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_implant <- sem2_implant[order(as.numeric(sem2_implant$ID), sem2_implant$e30, decreasing = FALSE), ]
sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & e26 == 1 ~ 1,
                                                        e30 == 1 & e26 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_h <- sem2_h[,c("ID","sexojefe")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")

sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

sem1 <- sem1 %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()




# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad

## Total país
sem1_h_svy <- sem1_h_svy %>% dplyr::mutate(menorH=men18h)
sem2_implant_h_svy <- sem2_implant_h_svy %>% dplyr::mutate(menorH=men18h)

a_mes <- sem1_h_svy %>%
  srvyr::group_by(mes) %>%
  srvyr::summarise(colname = srvyr::survey_mean(menorH))
a_sem <- mean(as.numeric(a_mes$colname))

b_sem <- sem2_implant_h_svy %>%
  srvyr::summarise(colname = srvyr::survey_mean(menorH))
b_sem <- as.numeric(b_sem$colname)

c_ano <- mean(c(a_sem, b_sem))


# Sexo del jefe

a_jefe <- function(x) {
  x <- sem1_h_svy %>%
    filter(sexojefe == x) %>%
    srvyr::group_by(mes) %>%
    srvyr::summarise(colname = srvyr::survey_mean(menorH))
  x <- mean(x$colname)
}       

a_e_jefe <- numeric()

for(i in 1:2){
  a_e_jefe[i] <- a_jefe(x = i)
}     

b_jefe <- function(x) {
  x <- sem2_implant_h_svy %>%
    filter(sexojefe == x) %>%
    srvyr::summarise(colname = srvyr::survey_mean(menorH))
  x <- mean(x$colname)
}       

b_e_jefe <- numeric()

for(i in 1:2){
  b_e_jefe[i] <- b_jefe(x = i)
}         

c_jefe <- as.data.frame(cbind(a_e_jefe, b_e_jefe))
c_jefe <- c_jefe %>% dplyr::mutate(m_jefe = (a_e_jefe + b_e_jefe)/2)
c_jefe <- c_jefe[,c("m_jefe")]
c_jefe <- as.data.frame(rbind(c_jefe, c_ano))

colnames(c_jefe) <-    c("Hogares con menores entre 0 y 17 años")
rownames(c_jefe)<- c("Varones", "Mujeres","Total")
estimacion2021 <- c_jefe

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`


<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 512,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad, según quintil de ingresos**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", URBANORURALUY == "Total país", EDAD=="Todos", POBRE=="Todos") %>%
mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
mutate(UNIDAD = case_when(
QUINTIL == "Quintil 1"~"Quintil 1", QUINTIL == "Quintil 2"~"Quintil 2",QUINTIL == "Quintil 3"~ "Quintil 3", QUINTIL == "Quintil 4"~"Quintil 4", QUINTIL == "Quintil 5"~"Quintil 5"))  %>%
mutate(UNIDAD = factor(UNIDAD, levels = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5")))  %>%
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 5, color = UNIDAD))+
  scale_color_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3","grey60"),
  ) +
  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, max, 1), limits=c(2006,max))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", URBANORURALUY == "Total país", EDAD=="Todos", POBRE=="Todos") %>%
mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
mutate(UNIDAD = case_when(
QUINTIL == "Quintil 1"~"Quintil 1", QUINTIL == "Quintil 2"~"Quintil 2",QUINTIL == "Quintil 3"~ "Quintil 3", QUINTIL == "Quintil 4"~"Quintil 4", QUINTIL == "Quintil 5"~"Quintil 5"))  %>%
mutate(UNIDAD = factor(UNIDAD, levels = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","QUINTIL","ANIO","VALOR")]
t1 <- t1[order(t1$QUINTIL, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 512,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###


# Ingresos
sem1 <- sem1 %>% dplyr::mutate(y_pc       =  HT11 / ht19 )                      #Ingreso per-cápita
sem1 <- sem1 %>% dplyr::mutate(y_pc_svl   =  (HT11 - HT13) / ht19)              #Ingreso per-cápita sin valor locativo

sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc       =  ht11 / ht19 )                      #Ingreso per-cápita
sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc_svl   =  (ht11 - ht13) / ht19)              #Ingreso per-cápita sin valor locativo

# Quintil de ingresos
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = pesomen))
sem1_h <- sem1_h[,c("numero","quintilesy")]
sem1 <- merge(sem1, sem1_h, by = "numero")

sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = w_sem))
sem2_h <- sem2_h[,c("ID","quintilesy")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")   

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

sem1 <- sem1 %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(men18 = case_when(bc_pe3<18 ~ 1, bc_pe3>=18 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(men18h=max(men18)) %>% as.data.frame()




# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Porcentaje de hogares en los que residen menores entre 0 y 17 años de edad, según quintil

sem1_h_svy <- sem1_h_svy %>% dplyr::mutate(menorH=men18h)
sem2_implant_h_svy <- sem2_implant_h_svy %>% dplyr::mutate(menorH=men18h)

# Quintil de ingreso del hogar

a_quintil <- function(x) {
  x <- sem1_h_svy %>%
    filter(quintilesy == x) %>%
    srvyr::group_by(mes) %>%
    srvyr::summarise(colname = srvyr::survey_mean(menorH))
  x <- mean(x$colname)
}       

a_e_quintil <- numeric()

for(i in 1:5){
  a_e_quintil[i] <- a_quintil(x = i)
}     

b_quintil <- function(x) {
  x <- sem2_implant_h_svy %>%
    filter(quintilesy == x) %>%
    srvyr::summarise(colname = srvyr::survey_mean(menorH))
  x <- mean(x$colname)
}       

b_e_quintil <- numeric()

for(i in 1:5){
  b_e_quintil[i] <- b_quintil(x = i)
}         

c_quintil <- as.data.frame(cbind(a_e_quintil, b_e_quintil))
c_quintil <- c_quintil %>% dplyr::mutate(m_quintil = (a_e_quintil + b_e_quintil)/2)
c_quintil <- c_quintil[,c("m_quintil")]
c_quintil <- as.data.frame(c_quintil)

colnames(c_quintil) <-    c("Hogares con menores entre 0 y 17 años")
rownames(c_quintil)<- c("Quintil 1", 
                        "Quintil 2",
                        "Quintil 3",
                        "Quintil 4",
                        "Quintil 5")
estimacion2021 <- c_quintil


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />


<div style="text-align: justify">
El siguiente indicador permite conocer la composición de los hogares según las edades de sus integrantes, en particular, de personas mayores de 65 años, resultando relevante para conocer la carga de cuidados en los hogares, el número de personas en edad jubilatoria, entre otras.

El porcentaje de hogares con mayores presenta una leve disminución en el período 2006-2021. Por un lado, puede verse que esta disminución es más marcada para los hogares con jefatura femenina. Por otro, en los quintiles de ingresos más bajos es donde este porcentaje es menor, encontrándose un porcentaje similar en los quiniles 3, 4 y 5.  

</div>
<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 513,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de hogares en los que residen mayores de 64 años de edad, según sexo del jefe/a del hogar**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(CODIND==513, NOMINDICADOR == "Porcentaje de hogares en los que residen mayores de 64 años", URBANORURALUY == "Total país", SEXO == "Todos"|SEXO=="Varones"|SEXO=="Mujeres", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  mutate(UNIDAD = case_when(
  SEXO =="Varones" ~ "Varones", SEXO == "Mujeres" ~ "Mujeres", SEXO=="Todos" ~ "Total"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Mujeres", "Varones", "Total")))  %>%
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 3, color = UNIDAD))+
  scale_color_manual(
    values = c(639, "#a1dd70", "darkorange"),
    labels = c("Varones", "Mujeres", "Total")
  ) +
  ylim(0, 60) +
  scale_x_continuous(breaks=seq(2006, max, 1), limits=c(2006,max))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen mayores de 64 años", URBANORURALUY == "Total país", SEXO == "Todos"|SEXO=="Varones"|SEXO=="Mujeres", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  mutate(UNIDAD = case_when(
  SEXO =="Varones" ~ "Varones", SEXO == "Mujeres" ~ "Mujeres", SEXO=="Todos" ~ "Total"))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","SEXO","ANIO","VALOR")]
t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 513,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)


# Sexo del jefe/a de hogar
sem1 <- sem1[order(sem1$numero, sem1$e30, decreasing = FALSE), ]
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & bc_pe2 == 1 ~ 1,
                                                        e30 == 1 & bc_pe2 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem1_h <- sem1_h[,c("numero","sexojefe")]
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1_h <- sem1_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem1 <- merge(sem1, sem1_h, by = "numero")
sem1 <- sem1 %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem1 <- sem1 %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_implant <- sem2_implant[order(as.numeric(sem2_implant$ID), sem2_implant$e30, decreasing = FALSE), ]
sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe = case_when(e30 == 1 & e26 == 1 ~ 1,
                                                        e30 == 1 & e26 == 2 ~ 2,
                                                        e30 != 1 ~ 99))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_h <- sem2_h %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

sem2_h <- sem2_h[,c("ID","sexojefe")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")

sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe1 = case_when(sexojefe==1 ~ 1, sexojefe!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(sexojefe2 = case_when(sexojefe==2 ~ 1, sexojefe!=2 ~ 0))

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

###Mayores de 64  
sem1 <- sem1 %>% dplyr::mutate(may64 = case_when(bc_pe3>64 ~ 1, bc_pe3<=64 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(may64 = case_when(bc_pe3>64 ~ 1, bc_pe3<=64 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(may64h=max(may64)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(may64h=max(may64)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Porcentaje de hogares en los que residen mayores de 64 años

## Total país

a_mes <- sem1_h_svy %>%
  srvyr::group_by(mes) %>%
  srvyr::summarise(colname = srvyr::survey_mean(may64h))
a_sem <- mean(as.numeric(a_mes$colname))

b_sem <- sem2_implant_h_svy %>%
  srvyr::summarise(colname = srvyr::survey_mean(may64h))
b_sem <- as.numeric(b_sem$colname)

c_ano <- mean(c(a_sem, b_sem))

# Sexo del jefe

a_jefe <- function(x) {
  x <- sem1_h_svy %>%
    filter(sexojefe == x) %>%
    srvyr::group_by(mes) %>%
    srvyr::summarise(colname = srvyr::survey_mean(may64h))
  x <- mean(x$colname)
}       

a_e_jefe <- numeric()

for(i in 1:2){
  a_e_jefe[i] <- a_jefe(x = i)
}     

b_jefe <- function(x) {
  x <- sem2_implant_h_svy %>%
    filter(sexojefe == x) %>%
    srvyr::summarise(colname = srvyr::survey_mean(may64h))
  x <- mean(x$colname)
}       

b_e_jefe <- numeric()

for(i in 1:2){
  b_e_jefe[i] <- b_jefe(x = i)
}         

c_jefe <- as.data.frame(cbind(a_e_jefe, b_e_jefe))
c_jefe <- c_jefe %>% dplyr::mutate(m_jefe = (a_e_jefe + b_e_jefe)/2)
c_jefe <- c_jefe[,c("m_jefe")]
c_jefe <- as.data.frame(c(c_jefe,c_ano))

colnames(c_jefe) <-    c("Hogares con mayores de 64 años")
rownames(c_jefe)<- c("Varones", "Mujeres", "Total")
estimacion2021 <- c_jefe

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 513,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de hogares en los que residen mayores de 64 años de edad, según quintil de ingresos**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen mayores de 64 años", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", URBANORURALUY == "Total país", EDAD=="Todos", POBRE=="Todos") %>%
mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
mutate(UNIDAD = case_when(
QUINTIL == "Quintil 1"~"Quintil 1", QUINTIL == "Quintil 2"~"Quintil 2",QUINTIL == "Quintil 3"~ "Quintil 3", QUINTIL == "Quintil 4"~"Quintil 4", QUINTIL == "Quintil 5"~"Quintil 5"))  %>%
mutate(UNIDAD = factor(UNIDAD, levels = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5")))  %>%
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 5, color = UNIDAD))+
  scale_color_manual(
    values = c("darkorange", 639,"#a1dd70","darksalmon","grey60"),
  ) +
  ylim(0, 60) +
  scale_x_continuous(breaks=seq(2006, max, 1), limits=c(2006,max))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
base %>% filter(NOMINDICADOR == "Porcentaje de hogares en los que residen mayores de 64 años", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Quintil 1"|QUINTIL == "Quintil 2"|QUINTIL == "Quintil 3"|QUINTIL == "Quintil 4"|QUINTIL == "Quintil 5", URBANORURALUY == "Total país", EDAD=="Todos", POBRE=="Todos") %>%
mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
mutate(UNIDAD = case_when(
QUINTIL == "Quintil 1"~"Quintil 1", QUINTIL == "Quintil 2"~"Quintil 2",QUINTIL == "Quintil 3"~ "Quintil 3", QUINTIL == "Quintil 4"~"Quintil 4", QUINTIL == "Quintil 5"~"Quintil 5"))  %>%
mutate(UNIDAD = factor(UNIDAD, levels = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","QUINTIL","ANIO","VALOR")]
t1 <- t1[order(t1$QUINTIL, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 513,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Ingresos
sem1 <- sem1 %>% dplyr::mutate(y_pc       =  HT11 / ht19 )                      #Ingreso per-cápita
sem1 <- sem1 %>% dplyr::mutate(y_pc_svl   =  (HT11 - HT13) / ht19)              #Ingreso per-cápita sin valor locativo

sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc       =  ht11 / ht19 )                      #Ingreso per-cápita
sem2_implant <- sem2_implant %>% dplyr::mutate(y_pc_svl   =  (ht11 - ht13) / ht19)              #Ingreso per-cápita sin valor locativo

# Quintil de ingresos
sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem1_h <- sem1_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = pesomen))
sem1_h <- sem1_h[,c("numero","quintilesy")]
sem1 <- merge(sem1, sem1_h, by = "numero")

sem2_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)
sem2_h <- sem2_h %>% dplyr::mutate(quintilesy = statar::xtile(y_pc, n=5, wt = w_sem))
sem2_h <- sem2_h[,c("ID","quintilesy")]
sem2_implant <- merge(sem2_implant, sem2_h, by = "ID")   

# Renombro edad
sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)


###Mayores de 64  
sem1 <- sem1 %>% dplyr::mutate(may64 = case_when(bc_pe3>64 ~ 1, bc_pe3<=64 ~ 0)) 
sem2_implant <- sem2_implant %>% dplyr::mutate(may64 = case_when(bc_pe3>64 ~ 1, bc_pe3<=64 ~ 0)) 
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(may64h=max(may64)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(may64h=max(may64)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Porcentaje de hogares en los que residen mayores de 64 años

## Total país

# Quintil de ingreso del hogar

a_quintil <- function(x) {
  x <- sem1_h_svy %>%
    filter(quintilesy == x) %>%
    srvyr::group_by(mes) %>%
    srvyr::summarise(colname = srvyr::survey_mean(may64h))
  x <- mean(x$colname)
}       

a_e_quintil <- numeric()

for(i in 1:5){
  a_e_quintil[i] <- a_quintil(x = i)
}     

b_quintil <- function(x) {
  x <- sem2_implant_h_svy %>%
    filter(quintilesy == x) %>%
    srvyr::summarise(colname = srvyr::survey_mean(may64h))
  x <- mean(x$colname)
}       

b_e_quintil <- numeric()

for(i in 1:5){
  b_e_quintil[i] <- b_quintil(x = i)
}         

c_quintil <- as.data.frame(cbind(a_e_quintil, b_e_quintil))
c_quintil <- c_quintil %>% dplyr::mutate(m_quintil = (a_e_quintil + b_e_quintil)/2)
c_quintil <- c_quintil[,c("m_quintil")]
c_quintil <- as.data.frame(c_quintil)
colnames(c_quintil) <-    c("Hogares con mayores de 64 años")
rownames(c_quintil)<- c("Quintil 1", 
                        "Quintil 2",
                        "Quintil 3",
                        "Quintil 4",
                        "Quintil 5")
estimacion2021 <- c_quintil


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />





## **Salida de hogar de origen**

<div style="text-align: justify">

La salida del hogar de origen representa uno de los eventos de transición a la adultez, marcando la conformación de un hogar propio. 

Es posible observar que el porcentaje de adolescentes y jóvenes que nunca se fueron de su hogar de origen alcanza el 62% tanto en 2008 como en 2013 y asciende a 66% en 2018. Por su parte, 29%, 28% y 24% se fueron de su hogar de origen y no retornaron en 2008, 2013 y 2018, respectivamente. Por último, 10% de adolescentes y jóvenes se fueron de su hogar de origen y volvieron, para los tres años considerados.

Al analizar este porcentaje según sexo, se observa que el porcentaje de mujeres que se fueron de su hogar de origen y no volvieron es mayor que el porcentaje de varones para los tres años. En 2018, 28,5% de mujeres adolescentes y jóvenes se fueron de su hogar de origen sin haber vuelto, mientras para los varones este porcentaje desciende a 19,5%.

</div>


<br />
<div style="text-align: center">

```{r}
periodo <- c("2008", ",", "2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((CODIND==518), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y volvieron" ~ "Salida del hogar de origen y volvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y no volvieron" ~ "Salida del hogar de origen y no nolvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que nunca se fueron de su hogar de origen" ~ "No salida del hogar de origen"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Salida del hogar de origen y volvieron", "Salida del hogar de origen y no nolvieron", "No salida del hogar de origen")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2008", "2013", "2018")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("indianred2", "darkorange", 639), guide = "none"
    
  ) +
  #  ylim(0, 100) +
  scale_x_discrete(   labels = c("2008", "2013", "2018")) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((CODIND==518), 
                  URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y volvieron" ~ "Salida del hogar de origen y volvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y no volvieron" ~ "Salida del hogar de origen y no nolvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que nunca se fueron de su hogar de origen" ~ "No salida del hogar de origen"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Salida del hogar de origen y volvieron", "Salida del hogar de origen y no nolvieron", "No salida del hogar de origen")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 518,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 



<br />
<div style="text-align: center">


```{r}
periodo <- c("2008", ",", "2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen, según sexo**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((CODIND==518), 
                  URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y volvieron" ~ "Salida del hogar de origen y volvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y no volvieron" ~ "Salida del hogar de origen y no nolvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que nunca se fueron de su hogar de origen" ~ "No salida del hogar de origen"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Salida del hogar de origen y volvieron", "Salida del hogar de origen y no nolvieron", "No salida del hogar de origen")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2008", "2013", "2018")))  %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  facet_wrap(~SEXO) +
  scale_fill_manual(
    values = c("indianred2", "darkorange", 639), guide = "none"
  ) +
  #  ylim(0, 100) +
  scale_x_discrete(   labels = c("2008", "2013", "2018")) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((CODIND==518), 
                  URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y volvieron" ~ "Salida del hogar de origen y volvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que se fueron de su hogar de origen y no volvieron" ~ "Salida del hogar de origen y no nolvieron", 
                            NOMINDICADOR== "Porcentaje de jóvenes y adolescentes que nunca se fueron de su hogar de origen" ~ "No salida del hogar de origen"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Salida del hogar de origen y volvieron", "Salida del hogar de origen y no nolvieron", "No salida del hogar de origen")))  %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","SEXO", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 518,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

<br />

# **Planificación familiar**

## **Adecuación a preferencias**

<div style="text-align: justify">

El concepto de planificación familiar se asocia a los derechos de salud sexual y reproductiva. Los beneficios de la planificación familiar se vinculan con la reducción de embarazos no deseados, de muerte materna, la mejora de la salud infantil y de la calidad y nivel de vida de las personas, entre otros. 

</div>

<br />
<div style="text-align: justify">

El siguiente indicador da cuenta del grado de cumplimiento de las preferencias reproductivas, vinculado a si deseaban o no tener hijos y el momento. Es posible observar que 7% de las personas que ellas o sus parejas quedaron embarazadas no querían tener hijos/as, en el entorno de 30% quería más adelante y casi 65% quería en ese momento. No se observan grandes diferencias según sexo.  
</div>

<br />
<div style="text-align: center">

```{r}
periodo <- c("2015" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de personas entre 15 y 44 años de edad que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían, según sexo**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico






```{r, out.width='100%'}
#===============================================================================
#===============================================================================
g1 <- 
  base %>% filter((NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería)"|
                     NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería más adelante)"|
                     NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (No quería)"), 
                  URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD_HIJ=="Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería)" ~ "Quería en ese momento",
                            NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería más adelante)" ~ "Quería más adelante",
                            NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (No quería)" ~ "No quería")) %>%
mutate(UNIDAD = factor(UNIDAD, levels = c("Quería en ese momento", "Quería más adelante", "No quería")))  %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  ggplot(aes(x = SEXO, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("indianred2", "darkorange", 639), guide = "none"
  ) +
  #  ylim(0, 100) +
  #scale_x_discrete(labels = c("Varones", "Mujeres", "Total")) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería)"|
                     NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería más adelante)"|
                     NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (No quería)"), 
                  URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD_HIJ=="Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(NOMINDICADOR = case_when(NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería)" ~ "Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería en ese momento)",
                            NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería más adelante)" ~ "orcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (Quería más adelante)",
                            NOMINDICADOR=="Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (No quería)" ~ "Porcentaje de personas que en su primer embarazo o el de su pareja querían tener un hijo en ese momento, querían más adelante o no querían (No quería)")) %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  rename(ANIO = FECHA) 
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "SEXO", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 525,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}


```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 





<br />

<div style="text-align: justify">

Este indicador da cuenta del grado de cumplimiento de las preferencias reproductivas, vinculado a la cantidad de hijos tenidos y deseados. Es posible observar que la mitad de las personas manifiestan haber tenido la cantidad de hijos/as que deseaban. 

</div>
<br />
<div style="text-align: center">


```{r}
periodo <- c("2015" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de personas según cantidad de hijos tenidos y deseados, según sexo**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico






```{r, out.width='100%'}
#===============================================================================
#===============================================================================



                   
                   
g1 <- 
  base %>% filter((NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MENOR)"|
                     NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (IGUAL)"|
                     NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MAYOR)"), 
                  URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD_HIJ=="Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MENOR)" ~ "Menor cantidad de hijos tenidos que deseados",
NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (IGUAL)" ~ "Igual cantidad de hijos tenidos que deseados",
NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MAYOR)" ~ "Mayor cantidad de hijos tenidos que deseados")) %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  ggplot(aes(x = SEXO, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("indianred2", "darkorange", 639), guide = "none"
  ) +
  #  ylim(0, 100) +
  #scale_x_discrete(labels = c("Varones", "Mujeres", "Total")) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MENOR)"|
                     NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (IGUAL)"|
                     NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MAYOR)"), 
                  URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD_HIJ=="Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(NOMINDICADOR = case_when(NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MENOR)" ~ "Porcentaje de personas según cantidad de hijos tenidos y deseados (Menor cantidad de hijos tenidos que deseados)",
NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (IGUAL)" ~ "Porcentaje de personas según cantidad de hijos tenidos y deseados (Igual cantidad de hijos tenidos que deseados)",
NOMINDICADOR=="Porcentaje de personas según cantidad de hijos tenidos y deseados (MAYOR)" ~ "Porcentaje de personas según cantidad de hijos tenidos y deseados (Mayor cantidad de hijos tenidos que deseados)")) %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","SEXO", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 526,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

<br />




<br />

<div style="text-align: justify">

Este indicador da cuenta del grado de cumplimiento de las preferencias reproductivas, vinculado al momento en que tuvieron el primer hijo y en que hubiesen preferido tenerlo. Puede verse que 40% de las personas tuvieron su primer hijo/a a la edad que deseaban tenerlo (este porcentaje es de 39% para las mujeres y 44% para los varones). Cabe destacar que mientras 37% de los varones tuvieron su primer hijo antes de lo que querían, este porcentaje aumenta a 47% para el caso de las mujeres. 
</div>

<br />
<div style="text-align: center">


```{r}
periodo <- c("2015" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener, según sexo**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
#===============================================================================


g1 <- 
  base %>% filter((NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MENOR)"|
                  NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (IGUAL)"|
                  NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MAYOR)"),                   URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD_HIJ=="Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MENOR)" ~ "Antes de lo que quería",
NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (IGUAL)" ~ "A la edad que quería",
NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MAYOR)" ~ "Después de lo que quería")) %>%
#mutate(UNIDAD = factor(UNIDAD, levels = c("Quería en ese momento", "Quería más adelante", "No quería")))  %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  ggplot(aes(x = SEXO, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("indianred2", "darkorange", 639), guide = "none"
  ) +
  #  ylim(0, 100) +
  #scale_x_discrete(labels = c("Varones", "Mujeres", "Total")) +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MENOR)"|
                  NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (IGUAL)"|
                  NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MAYOR)"),                   URBANORURALUY == "Total país", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD_HIJ=="Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(NOMINDICADOR = case_when(NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MENOR)" ~ "Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener (Antes de lo que quería)",
NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (IGUAL)" ~ "Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener (A la edad que quería)",
NOMINDICADOR=="Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener  (MAYOR)" ~ "Porcentaje de personas según edad a la que tuvieron primer hijo y a la que le hubiese gustado tener (Después de lo que quería)")) %>%
  mutate(SEXO = case_when(SEXO=="Mujeres"~"Mujeres", SEXO=="Varones"~"Varones",  SEXO=="Todos"~"Total"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones", "Total")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","SEXO", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 527,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

<br />

## **Fecundidad adolescente**

<div style="text-align: justify">

La tasa específica de fecundidad adolescente es un indicador que da cuenta de la evolución del embarazo adolescente. Este indicador presenta una disminución de 10 puntos porcentuales entre 1996 y 2013, pasado de 70,5 a 60,9 cada mil mujeres entre 15 y 19 años. A partir de dicho año y hasta 2021, se asiste a una disminución marcada y sostenida, alcanzando en 2021 el valor de 26 cada mil mujeres entre 15 y 19 años de edad.    

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- base[base$CODIND == 529,]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Tasa específica de fecundidad adolescente**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico






```{r, out.width='100%'}
#===============================================================================

g1 <- 
  base %>% filter(CODIND==529) %>%
  mutate(UNIDAD = case_when(NOMINDICADOR == "Tasa específica de fecundidad adolescente"  ~  "Total")) %>%  
  mutate(VALOR = round(as.numeric(VALOR),1)) %>% 
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 1, color = UNIDAD))+
 scale_color_manual(
    values = c(639)) +
  ylim(0, 75) +
  scale_x_continuous(breaks=seq(1996, max, 1)) +
  theme_minimal() +
  theme(legend.position="none", axis.text.x =  element_text(angle = 45)) +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 



#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(CODIND==529) %>%
  mutate(UNIDAD = case_when(NOMINDICADOR == "Tasa específica de fecundidad adolescente"  ~  "Total")) %>%  
  mutate(VALOR = round(as.numeric(VALOR),1)) %>% 
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","UNIDAD", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 529,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

<br />





# **Violencia de género**

## **Prevalencia en la familia**

<div style="text-align: justify">

La violencia de género se ha conceptualizado como toda forma de violencia dirigida hacia las mujeres por el hecho de ser mujeres. La ONU (1993)[^2] la define como diferentes actos violentos, o amenazas de dichos actos ejercidos contra las mujeres por el hecho de serlo, que generan o pueden generar un daño físico, sexual o psicológico. A partir de la convención interamericana para prevenir, sancionar y erradicar la violencia contra la mujer "Convención de Belem do Pará" se define la violencia de género como “cualquier acción o conducta, basada en su género, que cause muerte, daño o sufrimiento físico, sexual o psicológico a la mujer, tanto en el ámbito público como en el privado” (Convención Belém Do Pará, 1994)[^3]. Existen diferentes criterios para clasificar la violencia. Dos criterios relevantes son el espacio donde se produce (ámbito privado, laboral, educativo, social, entre otros) y el tipo de violencia que se ejerce (psicológica, física, sexual, entre otras).

[^2]: ONU (1993). Declaración sobre la eliminación de la violencia contra la mujer. Asamblea General, Naciones Unidas. Distr. General A/RES/48/104. Disponible en: https://www.acnur.org/fileadmin/Documentos/BDL/2002/1286.pdf?file=fileadmin/Documentos/BDL/2002/1286  
[^3]: Convención Belém do Pará (1994). Convención interamericana para prevenir, sancionar y erradicar la violencia contra la mujer. Disponible en: https://www.oas.org/juridico/spanish/tratados/a-61.html 

</div>
<div style="text-align: justify">

Los siguientes indicadores permiten conocer la prevalencia de diferentes tipos de violencia por parte de la familia en diferentes etapas del ciclo vital: aquellas situaciones vividas antes de los 15 años, en la actualidad o aquellas vividas a partir de los 65 años de edad. A su vez, se presenta la violencia vivida por parte de la pareja o expareja. En los indicadores se incluye la violencia física, psicológica, sexual, digital y económica. 

34,2% de las mujeres 15 años o más manifestaron haber vivido situaciones de  violencia de género por parte de la familia en la infancia en 2013, prevalencia que asciende a 38,4% en 2019, observándose que el tipo de violencia que presenta una mayor prevalencia es la violencia física, seguido de la psicológica y, por último, la sexual.  


</div>
<br />
<div style="text-align: center">


```{r}
periodo <- c("2013", "y", "2019" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Prevalencia de violencia basada en género por parte de la familia en la infancia**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Sexual)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Física)"
), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Sexual)" ~ "Sexual",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Física)" ~ "Física"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Física", "Psicológica", "Sexual")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2019")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill = UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("grey60", "darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 40) +
  scale_x_discrete(   labels = c("Total", "Física", "Psicológica", "Sexual")) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100))


#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Sexual)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Física)"
), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Sexual)" ~ "Sexual",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia en la infancia (Física)" ~ "Física"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Física", "Psicológica", "Sexual")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 535,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 





<div style="text-align: justify">

En el entorno del 20% de las mujeres de 15 años o más vivieron situaciones de violencia por parte de su familia actual en los últimos 12 meses, observando que en prácticamente todos los casos se vivió violencia psicológica. 

</div>


<br />
<div style="text-align: center">



```{r}
periodo <- c("2013", "y", "2019" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Prevalencia de violencia basada en género por parte de la familia actual**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Económica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Física)"
), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Económica)" ~ "Económica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Física)" ~ "Física"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Psicológica", "Económica", "Física")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2019")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("grey60", "darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 30) +
  scale_x_discrete(   labels = c("Total", "Psicológica", "Económica", "Física")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Económica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Física)"
), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Económica)" ~ "Económica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la familia actual (Física)" ~ "Física"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Física", "Psicológica", "Económica")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 536,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 




<div style="text-align: justify">

En el siguiente gráfico puede observarse que 9,5% de las mujeres de 65 años o más vivieron violencia de género en los últimos 12 meses en 2013, porcentaje que asciende a 10,5% en 2019. 
</div>

<br />
<div style="text-align: center">


```{r}
periodo <- c("2013", "y", "2019" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Prevalencia de violencia basada en género de mujeres de 65 años o más por parte de la familia **
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((CODIND==537), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(FECHA = factor(FECHA, levels = c("2013", "2019")))  %>%
  ggplot(aes(x = FECHA, y = VALOR, fill=FECHA)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("darkseagreen4", "darkseagreen3"), guide = "none"
  ) +
  ylim(0, 20) +
  scale_x_discrete(   labels = c("2013", "2019")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((CODIND==537), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 537,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 


## **Prevalencia en la pareja**

<div style="text-align: justify">

La violencia de género por parte de la pareja o expareja en los últimos 12 meses alcanza a 23,7% y 20,5% de las mujeres de 15 años o más que tienen o han tenido pareja en 2013 y 2019, respectivamente. En este caso, el tipo de violencia con una mayor prevalencia es la violencia psicológica.  


</div>
<br />
<div style="text-align: center">


```{r}
periodo <- c("2013", "y", "2019" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Prevalencia de violencia basada en género por parte de la pareja o expareja, en los últimos 12 meses**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico






```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Económica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Física)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Sexual)"), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Económica)" ~ "Económica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Física)" ~ "Física",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Sexual)" ~ "Sexual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Psicológica", "Económica", "Física", "Sexual")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2019")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("grey60", "darkseagreen2", "darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 30) +
  scale_x_discrete(   labels = c("Total", "Psicológica", "Económica", "Física", "Sexual")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Económica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Física)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Sexual)"), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Económica)" ~ "Económica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Física)" ~ "Física",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja en los últimos 12 meses (Sexual)" ~ "Sexual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Física", "Psicológica", "Sexual", "Económica")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 538,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 


<div style="text-align: justify">

Por su parte, puede observarse que del total de mujeres de 15 años o más que tienen o han tenido pareja, 45,4% y 48,7% (en 2013 y 2019, respectivamente) vivieron violencia de género por parte de la pareja o expareja a lo largo de toda la vida. El tipo de violencia con una mayor prevalencia es la violencia psicológica. 

</div>
<br />
<div style="text-align: center">

```{r}
periodo <- c("2013", "y", "2019" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Prevalencia de violencia basada en género por parte de la pareja o expareja, a lo largo de toda la vida**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico






```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Económica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Física)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Sexual)"), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Económica)" ~ "Económica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Física)" ~ "Física",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Sexual)" ~ "Sexual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Psicológica", "Económica", "Física", "Sexual")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2019")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("grey60", "darkseagreen2", "darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 50) +
  scale_x_discrete(   labels = c("Total", "Psicológica", "Económica", "Física", "Sexual")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter((NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Total)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Psicológica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Económica)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Física)"|
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Sexual)"), 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", NSE=="Todos", NIVELEDU=="Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Total)" ~ "Total",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Psicológica)" ~ "Psicológica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Económica)" ~ "Económica",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Física)" ~ "Física",
NOMINDICADOR=="Prevalencia de violencia basada en género por parte de la pareja o expareja a lo largo de toda la vida (Sexual)" ~ "Sexual"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Total", "Física", "Psicológica", "Sexual", "Económica")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 539,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 



<br />

# **Cuidados y educación**
## **Participación en cuidados**

<div style="text-align: justify">

Se definen los cuidados como las actividades que se realizan con el fin de ayudar a una persona en situación de dependencia en el desarrollo de su vida diaria. Implica cuidados materiales o económicos y psicológicos, involucrando vínculos afectivos. Las actividades de cuidado pueden realizarse de forma remunerada o no remunerada, en el marco de la familia o por fuera (Letablier, 2001[^4]; Aguirre et al, 2014[^5]). 

La organización social del cuidado refiere a la forma de distribuir las actividades de cuidados de las personas en situación de dependencia en una sociedad, interviniendo cuatro actores en la provisión de los cuidados: familia, Estado, mercado y comunidad. Según cómo se estructura la organización del cuidado es posible diferenciar regímenes de bienestar familistas, cuando la responsabilidad principal por la provisión de cuidados recae en las familias, y desfamiliarizados, cuando hay una delegación sustancial de las actividades de cuidado en el Estado y el mercado (Aguirre, 2008[^6]).

[^4]: Letablier, Marie-Thérèse (2001). Le travail centré sur autrui e sa conceptualisation en Europe. En Travail, genre et societés. Dossier: Femmes providentielles, enfants et parents à charge, Nº 6, Paris: L' Harmattan, pp. 19-41
[^5]: Aguirre, Rosario, Batthyány, Karina, Genta, Natalia y Perrotta, Valentina (2014). Los cuidados en la agenda de investigación y en las políticas públicas en Uruguay. Íconos. Revista de Ciencias Sociales. Nº 50, septiembre 2014, pp. 43-60. Quito: Facultad Latinoamericana de Ciencias Sociales-Sede Académica de Ecuador. Disponible en: https://www.redalyc.org/pdf/509/50931716003.pdf
[^6]: Aguirre, Rosario (2008). La necesaria redefinición de la noción de trabajo. Problemas conceptuales y metodológicos. Aportes para el Estado y la Administración Gubernamental, Año 14, Nº 25, Buenos Aires. Disponible en: https://www.asociacionag.org.ar/pdfaportes/25/02.pdf 

Por su parte, se presentan indicadores de asistencia a la educación inicial, preescolar y escolar, comprendiéndose como un factor fundamental en la integración social de los niños y niñas y su desarrollo.


</div>

<br />


<div style="text-align: justify">

Los siguientes indicadores dan cuenta de la tasa de participación de mujeres y varones entre 14 y 49 años de edad según presencia de menores en el hogar. Es posible observar que la brecha en la tasa de participación entre mujeres y varones aumenta cuando conviven con niños de menor edad, encontrándose una mayor brecha para mujeres y varones que viven con niños/as de 0 a 3 años. Sin embargo, cabe mencionar que la brecha se reduce entre 2006 y 2021 para los tres tramos de edad considerados.     


</div>
<br />
<div style="text-align: center">



```{r}
periodo <- base[base$CODIND==542,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Tasa de participación de mujeres y varones entre 14 y 49 años según presencia de menores en el hogar**
##### Total país, `r periodo_formatted`
</div>
### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Mujer)"| 
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Mujer)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Mujer)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Mujer)", URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>%
  rename(SEXO_ANT=SEXO) %>%
  mutate(SEXO = case_when(NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Varón)" ~ "Varones",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Mujer)" ~ "Mujeres", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Varón)" ~ "Varones",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Mujer)" ~ "Mujeres", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Varón)" ~ "Varones",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Mujer)" ~ "Mujeres", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Varón)" ~ "Varones", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Mujer)" ~ "Mujeres"))  %>%
    mutate(EDAD = case_when(NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Varón)" ~ "Entre 0 y 3",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Mujer)" ~ "Entre 0 y 3", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Varón)" ~ "Entre 0 y 6",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Mujer)" ~ "Entre 0 y 6", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Varón)" ~ "Entre 0 y 12",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Mujer)" ~ "Entre 0 y 12",  NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Varón)" ~ "Sin menores entre 0 y 12", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Mujer)" ~ "Sin menores entre 0 y 12"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Varones", "Mujeres")))  %>%
  mutate(EDAD = factor(EDAD, levels = c("Entre 0 y 3", "Entre 0 y 6", "Entre 0 y 12", "Sin menores entre 0 y 12")))  %>%
ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 2, color = SEXO))+
  scale_color_manual(
    values = c("darkorange", 639)) +
    facet_wrap(~EDAD) +
  ylim(0, 100) +
  scale_x_continuous(breaks=seq(2006, 2021, 1), limits=c(2006,2021))  +
  theme_minimal() +
  theme(legend.position="none", axis.text.x =  element_text(angle = 45)) +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Mujer)"| 
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Mujer)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Mujer)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Varón)"|
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Mujer)", URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>%
  rename(SEXO_ANT=SEXO) %>%
  mutate(SEXO = case_when(NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Varón)" ~ "Varones",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Mujer)" ~ "Mujeres", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Varón)" ~ "Varones",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Mujer)" ~ "Mujeres", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Varón)" ~ "Varones",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Mujer)" ~ "Mujeres", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Varón)" ~ "Varones", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Mujer)" ~ "Mujeres"))  %>%
    mutate(EDAD = case_when(NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Varón)" ~ "Entre 0 y 3",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 4 en el hogar (Mujer)" ~ "Entre 0 y 3", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Varón)" ~ "Entre 0 y 6",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 7 en el hogar (Mujer)" ~ "Entre 0 y 6", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Varón)" ~ "Entre 0 y 12",
NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años con presencia de menores de 13 en el hogar (Mujer)" ~ "Entre 0 y 12",  NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Varón)" ~ "Sin menores entre 0 y 12", NOMINDICADOR=="Tasa de participación de mujeres y varones entre 14 y 49 años sin menores en el hogar (Mujer)" ~ "Sin menores entre 0 y 12"))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Varones", "Mujeres")))  %>%
  mutate(EDAD = factor(EDAD, levels = c("Entre 0 y 3", "Entre 0 y 6", "Entre 0 y 12", "Sin menores entre 0 y 12"))) %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "SEXO", "EDAD", "ANIO","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 542,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Renombro edad

sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
### Menores de 4 en el hogar
sem1 <- sem1 %>% dplyr::mutate(menor4 = case_when(bc_pe3<4 ~ 1, bc_pe3>=4 ~ 0))
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(menor4H=max(menor4)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% dplyr::mutate(menor4 = case_when(bc_pe3<4 ~ 1, bc_pe3>=4 ~ 0))
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(menor4H=max(menor4)) %>% as.data.frame()

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
### Menores de 7 en el hogar
sem1 <- sem1 %>% dplyr::mutate(menor7 = case_when(bc_pe3<7 ~ 1, bc_pe3>=7 ~ 0))
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(menor7H=max(menor7)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% dplyr::mutate(menor7 = case_when(bc_pe3<7 ~ 1, bc_pe3>=7 ~ 0))
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(menor7H=max(menor7)) %>% as.data.frame()

### Menores de 13 en el hogar
sem1 <- sem1 %>% dplyr::mutate(menor13 = case_when(bc_pe3<13 ~ 1, bc_pe3>=13 ~ 0))
sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(menor13H=max(menor13)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% dplyr::mutate(menor13 = case_when(bc_pe3<13 ~ 1, bc_pe3>=13 ~ 0))
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(menor13H=max(menor13)) %>% as.data.frame()

# Sexo
sem1 <- sem1 %>% dplyr::mutate(bc_pe2 = E26)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe2 = e26)

##Condición de actividad
sem1 <- sem1 %>% dplyr::mutate(bc_pobp = POBPCOAC)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pobp = pobpcoac)

###Activos
sem1 <- sem1 %>% dplyr::mutate(activos1 = case_when(bc_pe2==1&bc_pobp>5 ~ 0, bc_pobp>=2&bc_pobp<=5&bc_pe2==1 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(activos1 = case_when(bc_pe2==1&bc_pobp>5 ~ 0, bc_pobp>=2&bc_pobp<=5&bc_pe2==1 ~ 1))

sem1 <- sem1 %>% dplyr::mutate(activos2 = case_when(bc_pe2==2&bc_pobp>5 ~ 0, bc_pobp>=2&bc_pobp<=5&bc_pe2==2 ~ 1))
sem2_implant <- sem2_implant %>% dplyr::mutate(activos2 = case_when(bc_pe2==2&bc_pobp>5 ~ 0, bc_pobp>=2&bc_pobp<=5&bc_pe2==2 ~ 1))

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Tasa de participación de mujeres y varones entre 14 y 49 años de edad, según presencia de menores en el hogar

## Sin menores

sem1_svy_1 <- sem1_svy %>%
  filter(menor13H == 0 & (bc_pe3>13 | bc_pe3<50))
sem2_implant_svy_1 <- sem2_implant_svy %>%
  filter(menor13H == 0 & (bc_pe3>13 | bc_pe3<50))

var_int <- c("activos1", "activos2")

a_sem <- sapply(sem1_svy_1$variables %>% select(var_int), function(x){
  sem1_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_svy_1$variables %>% select(var_int), function(x){
  sem2_implant_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano_sin <- matrix(,2,1)
for (i in 1:2) {
  c_ano_sin[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}


##Con menores de 0 a 13
sem1_svy_1 <- sem1_svy %>%
  filter(menor13H == 1 & (bc_pe3>13 | bc_pe3<50))
sem2_implant_svy_1 <- sem2_implant_svy %>%
  filter(menor13H == 1 & (bc_pe3>13 | bc_pe3<50))


var_int <- c("activos1", "activos2")
a_sem <- sapply(sem1_svy_1$variables %>% select(var_int), function(x){
  sem1_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_svy_1$variables %>% select(var_int), function(x){
  sem2_implant_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano_0a13 <- matrix(,2,1)
for (i in 1:2) {
  c_ano_0a13[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}


##Con menores de 0 a 4

sem1_svy_1 <- sem1_svy %>%
  filter(menor4H==1 & (bc_pe3>13 | bc_pe3<50))
sem2_implant_svy_1 <- sem2_implant_svy %>%
  filter(menor4H==1 & (bc_pe3>13 | bc_pe3<50))


# Total

var_int <- c("activos1", "activos2")
a_sem <- sapply(sem1_svy_1$variables %>% select(var_int), function(x){
  sem1_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_svy_1$variables %>% select(var_int), function(x){
  sem2_implant_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano_0a4 <- matrix(,2,1)
for (i in 1:2) {
  c_ano_0a4[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}

## Con menores entre 0 y 6

sem1_svy_1 <- sem1_svy %>%
  filter(menor7H==1 & (bc_pe3>13 | bc_pe3<50))
sem2_implant_svy_1 <- sem2_implant_svy %>%
  filter(menor7H==1 & (bc_pe3>13 | bc_pe3<50))

var_int <- c("activos1", "activos2")
a_sem <- sapply(sem1_svy_1$variables %>% select(var_int), function(x){
  sem1_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

b_sem <- sapply(sem2_implant_svy_1$variables %>% select(var_int), function(x){
  sem2_implant_svy_1 %>%
    srvyr::summarise(stat = srvyr::survey_mean(x, na.rm = TRUE)) 
})

c_ano_0a6 <- matrix(,2,1)
for (i in 1:2) {
  c_ano_0a6[i,1] <- c(mean(as.numeric(c(a_sem[1,i], b_sem[1,i]))))
}

c_ano <- cbind(c_ano_0a4, c_ano_0a6, c_ano_0a13, c_ano_sin)

rownames(c_ano) <-    c("Varones", "Mujeres")
colnames(c_ano)<- c("Entre 0 y 3","Entre 0 y 6", "Entre 0 y 12", "Sin menores entre 0 y 12")
estimacion2021 <- c_ano

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`


<br />



<div style="text-align: justify">

Los siguientes indicadores reflejan la distribución de las tareas de cuidados entre personas familiares o no familiares, pudiendo comprender las diferencias por sexo y rol de parentesco, tanto cotidianamente como cuando surgen emergentes que es necesario atender.  

Al analizar la participación de las personas en los cuidados de los niños/as fuera del horario escolar, se observa que quien tiene una mayor participación son las madres, alcanzando casi al 100%, tanto en 2013 como en 2018. En segundo lugar, le siguen los padres, aumentando su participación desde 60,6% en 2013 a 79,7% en 2018. En tercer lugar, la participación de las/os abuelas/os se ubica en el entorno de 40%. En menor medida se encuentran otros parientes y no parientes, hermanos/as y personas remuneradas.      
</div>
<br />
<div style="text-align: center">

```{r}
periodo <- c("2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Participación de personas en el cuidado de niños/as fuera del horario escolar**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Madre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Padre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Hermano/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Abuelo/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Otro pariente o no pariente)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Persona remunerada)", 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Madre)" ~ "Madre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Padre)" ~ "Padre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Hermano/a)" ~ "Hermano/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Abuelo/a)" ~ "Abuelo/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Otro pariente o no pariente)" ~ "Otro pariente o no pariente",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Persona remunerada)" ~ "Persona remunerada"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Madre", "Padre", "Abuelo/a", "Otro pariente o no pariente", "Hermano/a", "Persona remunerada")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2018")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("darkolivegreen4", "darkseagreen4", "darkseagreen", "darkseagreen3", "darkseagreen2", "darkseagreen1"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 100) +
  scale_x_discrete(   labels = c("Madre", "Padre", "Abuelo/a", "Otro pariente o no pariente", "Hermano/a", "Persona remunerada")) +
  theme_minimal() +
  theme(legend.position="none", axis.text.x =  element_text(angle = 45)) +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Madre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Padre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Hermano/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Abuelo/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Otro pariente o no pariente)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Persona remunerada)", 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Madre)" ~ "Madre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Padre)" ~ "Padre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Hermano/a)" ~ "Hermano/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Abuelo/a)" ~ "Abuelo/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Otro pariente o no pariente)" ~ "Otro pariente o no pariente",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as fuera del horario escolar (Persona remunerada)" ~ "Persona remunerada"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Madre", "Padre", "Hermano/a", "Abuelo/a", "Otro pariente o no pariente", "Persona remunerada")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 547,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 




<div style="text-align: justify">
Cuando los niños/as enferman quienes principalmente se encargan del cuidado son las madres, con una participación de 93%. Los padres, por su parte, participan en un 55%. En tercer lugar, le siguien las/os abuelas/os, con una participación que desciende de 46,6% en 2013 a 31,6% en 2018. 
</div>

<br />
<div style="text-align: center">


```{r}
periodo <- c("2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Personas que participan en el cuidado de niños/as cuando enferman**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico






```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Madre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Padre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Hermano/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Abuelo/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Otro pariente o no pariente)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Persona remunerada)", 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Madre)" ~ "Madre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Padre)" ~ "Padre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Hermano/a)" ~ "Hermano/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Abuelo/a)" ~ "Abuelo/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Otro pariente o no pariente)" ~ "Otro pariente o no pariente",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Persona remunerada)" ~ "Persona remunerada"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Madre", "Padre", "Abuelo/a", "Otro pariente o no pariente", "Persona remunerada", "Hermano/a")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2018")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("darkolivegreen4", "darkseagreen4", "darkseagreen", "darkseagreen3", "darkseagreen2", "darkseagreen1"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 100) +
  scale_x_discrete(   labels = c("Madre", "Padre", "Abuelo/a", "Otro pariente o no pariente", "Persona remunerada", "Hermano/a")) +
  theme_minimal() +
  theme(legend.position="none", axis.text.x =  element_text(angle = 45)) +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Madre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Padre)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Hermano/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Abuelo/a)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Otro pariente o no pariente)"|
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Persona remunerada)", 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Madre)" ~ "Madre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Padre)" ~ "Padre",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Hermano/a)" ~ "Hermano/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Abuelo/a)" ~ "Abuelo/a",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Otro pariente o no pariente)" ~ "Otro pariente o no pariente",
NOMINDICADOR=="Participación de personas en el cuidado de niños/as cuando enferman (Persona remunerada)" ~ "Persona remunerada"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Madre", "Padre", "Hermano/a", "Abuelo/a", "Otro pariente o no pariente", "Persona remunerada")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 548,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}


```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 



<div style="text-align: justify">
La tasa de participación de las mujeres en las actividades de cuidados es mayor que la de los varones para todas las subpoblaciones consideradas. La tasa más alta se alcanza para el cuidado de niños/as de 0 a 3 años de edad, alcanzando el 90% para las mujeres y 68% para los varones.  

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- c("2013")
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Tasa de participación en las actividades de cuidados dentro del hogar**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico

```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (personas con discapacidad)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 0 a 3 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 4 a 5 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 6 a 12 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (mayores de 65 años)", 
URBANORURALUY == "Total país", SEXO == "Mujeres"|SEXO=="Varones", ASCENDENCIA == "Todos", QUINTIL == "Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (personas con discapacidad)" ~ "Personas con discapacidad",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 0 a 3 años)" ~ "Niños/as de 0 a 3 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 4 a 5 años)" ~ "Niños/as de 4 a 5 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 6 a 12 años)" ~ "Niños/as de 6 a 12 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (mayores de 65 años)" ~ "Mayores de 65 años"))  %>%
  mutate(SEXO = case_when(SEXO=="Mujeres" ~ "Mujeres", SEXO=="Varones" ~ "Varones")) %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Niños/as de 0 a 3 años", "Niños/as de 4 a 5 años", "Niños/as de 6 a 12 años", "Personas con discapacidad", "Mayores de 65 años")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013")))  %>%
  mutate(SEXO = factor(SEXO, levels = c("Mujeres", "Varones")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c( "darkseagreen1", "darkseagreen2", "darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~SEXO) +
  ylim(0, 100) +
  scale_x_discrete(   labels = c("Niños/as de 0 a 3 años", "Niños/as de 4 a 5 años", "Niños/as de 6 a 12 años", "Personas con discapacidad", "Mayores de 65 años")) +
  theme_minimal() +
  theme(legend.position="none", axis.text.x =  element_text(angle = 45)) +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (personas con discapacidad)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 0 a 3 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 4 a 5 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 6 a 12 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 0 a 12 años)"|
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (mayores de 65 años)", 
URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (personas con discapacidad)" ~ "Personas con discapacidad",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 0 a 3 años)" ~ "Niños/as de 0 a 3 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 4 a 5 años)" ~ "Niños/as de 4 a 5 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 6 a 12 años)" ~ "Niños/as de 6 a 12 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (niños/as de 0 a 12 años)" ~ "Niños/as de 0 a 12 años",
NOMINDICADOR=="Tasa de participación en las actividades de cuidados dentro del hogar (mayores de 65 años)" ~ "Mayores de 65 años"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Niños/as de 0 a 3 años", "Niños/as de 4 a 5 años", "Niños/as de 6 a 12 años", "Niños/as de 0 a 12 años", "Personas con discapacidad", "Mayores de 65 años")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 549,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 


<br />

## **Asistencia a centros educativos**

<div style="text-align: justify">
Los siguientes indicadores dan cuenta de la asistencia a centros de cuidado y educación por parte de niños y niñas entre 0 y 5 años de edad. Es posible observar que tanto la asistencia de niños/as entre 0 y 2 años como entre 3 y 5 años aumenta en los períodos considerados. En el caso de los niños/as de 0 a 2 años puede verse que el porcentaje de asistencia pasa de 27,1% en 2012 a 38% en 2019. Por su parte, el porcentaje de asistencia de niños/as de 3 a 5 años aumenta de 55,7% en 1990 a 90,4% en 2019. 
</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 551,]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Tasa de asistencia a la educación inicial de niños/as de 0 a 2 años**
##### Total país, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR == "Tasa de asistencia a la educación inicial de niños/as de 0 a 2 años", URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 1, color = NOMINDICADOR))+
  scale_color_manual(
    values = c("darkorange")) +
  ylim(0, 50) +
  scale_x_continuous(breaks=seq(2012, max, 1), limits=c(2012,max))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR == "Tasa de asistencia a la educación inicial de niños/as de 0 a 2 años", URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 551,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`



<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 552,]
#periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Tasa de asistencia a la educación de niños/as de 3 a 5 años**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR == "Tasa de asistencia a la educación de niños/as de 3 a 5 años", URBANORURALUY == "Urbano (más de 5.000 habitantes)", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 1, color = NOMINDICADOR))+
  scale_color_manual(
    values = c("darkorange")) +
  ylim(0, 100) +
  scale_x_continuous(breaks=seq(1990, max, 1), limits=c(1990,max))  +
  theme_minimal() +
  theme(legend.position="none", axis.text.x =  element_text(angle = 45)) +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR == "Tasa de asistencia a la educación de niños/as de 3 a 5 años", URBANORURALUY == "Urbano (más de 5.000 habitantes)", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS","ANIO","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 552,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`



<br />

# **Salud infantil**

 
<br />

<div style="text-align: justify">

La salud infantil refiere a la posibilidad de que los niños y niñas puedan satisfacer sus necesidades, desarrollar su potencial y sus capacidades. Es un aspecto fundamental que contribuye al bienestar y desarrollo integral de niños y niñas.


</div>
<br />

## **Lactancia**

<div style="text-align: justify">

El indicador refleja el porcentaje de niños que en sus primeros 6 meses reciben lactancia exclusiva, recomendado por la OMS para la buena nutrición de los bebés en los primeros años de vida. Se puede observar que el porcentaje de niños/as que recibieron lactancia exclusiva hasta los 6 meses pasó de 50% en 2013 a 57% en 2018, no encontrándose diferencias sustanciales entre Montevideo y el Interior del país.     

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- c("2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de niños lactantes que reciben lactancia exclusiva durante los primeros 6 meses**
##### País urbano, `r periodo_formatted`

</div>
### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}


#===============================================================================
g1<-
  base %>% filter(NOMINDICADOR=="Porcentaje de niños lactantes que reciben lactancia exclusiva durante los primeros 6 meses", 
URBANORURALUY == "Total país"| URBANORURALUY=="Montevideo"| URBANORURALUY=="Interior urbano", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(URBANORURALUY=="Total país" ~ "Todos",
URBANORURALUY=="Montevideo" ~ "Montevideo",
URBANORURALUY=="Interior urbano" ~ "Interior urbano"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Montevideo", "Interior urbano", "Todos")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2018")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 75) +
  scale_x_discrete(labels = c("Montevideo", "Interior urbano", "Todos")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100))

#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de niños lactantes que reciben lactancia exclusiva durante los primeros 6 meses", 
URBANORURALUY == "Total país"|URBANORURALUY=="Montevideo"|URBANORURALUY=="Interior urbano", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(URBANORURALUY=="Total país" ~ "Todos",
URBANORURALUY=="Montevideo" ~ "Montevideo",
URBANORURALUY=="Interior urbano" ~ "Interior urbano"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Montevideo", "Interior urbano", "Todos")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "UNIDAD", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 555,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 



<br />

## **Peso al nacer**

<div style="text-align: justify">

El indicador refleja el porcentaje de niños con bajo peso al nacer, es decir, por debajo de 2500 g. Es un indicador sumamente relevante en tanto repercute en el desarrollo y crecimiento satisfactorios, observándose que el mismo se ubica en el entorno del 7%.    

</div>

<br />
<div style="text-align: center">


```{r}
periodo <- c("2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de nacidos vivos con bajo peso al nacer**
##### País urbano, `r periodo_formatted`

</div>
### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de nacidos vivos con bajo peso al nacer", 
URBANORURALUY == "Total país"| URBANORURALUY=="Montevideo"| URBANORURALUY=="Interior urbano", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(URBANORURALUY=="Total país" ~ "Todos",
URBANORURALUY=="Montevideo" ~ "Montevideo",
URBANORURALUY=="Interior urbano" ~ "Interior urbano"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Montevideo", "Interior urbano", "Todos")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2018")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none") +
  facet_wrap(~FECHA) +
  ylim(0, 15) +
  scale_x_discrete(labels = c("Montevideo", "Interior urbano", "Todos")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100)) 


#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de nacidos vivos con bajo peso al nacer", 
URBANORURALUY == "Total país"|URBANORURALUY=="Montevideo"|URBANORURALUY=="Interior urbano", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(URBANORURALUY=="Total país" ~ "Todos",
URBANORURALUY=="Montevideo" ~ "Montevideo",
URBANORURALUY=="Interior urbano" ~ "Interior urbano"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Montevideo", "Interior urbano", "Todos")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "UNIDAD", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 556,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

<br />




<div style="text-align: justify">

El indicador refleja el porcentaje de niños con peso elevado al nacer, es decir, por encima de 4000 g. Es un indicador relevante en tanto puede ocasionar problemas en la salud durante y después del parto. Este indicador presenta una disminución en 2018 (8%) respecto a 2013 (11%). 
</div>

<br />
<div style="text-align: center">

```{r}
periodo <- c("2013", "y", "2018" )
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de nacidos vivos con macrosomía**
##### País urbano, `r periodo_formatted`
</div>

### {.tabset .tabset-fade .tabset-pills}
#### Gráfico


```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de nacidos vivos con macrosomía", 
URBANORURALUY == "Total país"|URBANORURALUY=="Montevideo"|URBANORURALUY=="Interior urbano", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(URBANORURALUY=="Total país" ~ "Todos",
URBANORURALUY=="Montevideo" ~ "Montevideo",
URBANORURALUY=="Interior urbano" ~ "Interior urbano"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Montevideo", "Interior urbano", "Todos")))  %>%
  mutate(FECHA = factor(FECHA, levels = c("2013", "2018")))  %>%
  ggplot(aes(x = UNIDAD, y = VALOR, fill=UNIDAD)) +
  geom_bar(stat="identity", width=0.3)+
  scale_fill_manual(
    values = c("darkseagreen3", "darkseagreen", "darkseagreen4"), guide = "none"
  ) +
  facet_wrap(~FECHA) +
  ylim(0, 15) +
  scale_x_discrete(labels = c("Montevideo", "Interior urbano", "Todos")) +
  theme_minimal() +
  theme(legend.position="none") +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 


#===============================================================================

```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de nacidos vivos con macrosomía", 
URBANORURALUY == "Total país"|URBANORURALUY=="Montevideo"|URBANORURALUY=="Interior urbano", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL == "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round(as.numeric(VALOR)*100,1)) %>% 
  mutate(UNIDAD = case_when(URBANORURALUY=="Total país" ~ "Todos",
URBANORURALUY=="Montevideo" ~ "Montevideo",
URBANORURALUY=="Interior urbano" ~ "Interior urbano"))  %>%
  mutate(UNIDAD = factor(UNIDAD, levels = c("Montevideo", "Interior urbano", "Todos")))  %>%
  rename(ANIO = FECHA)
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "UNIDAD", "ANIO","VALOR")]
#t1 <- t1[order(t1$SEXO, t1$ANIO), ]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 557,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

<br />


## **Cobertura de salud**


<div style="text-align: justify">
El siguiente indicador da cuenta del porcentaje de niños y niñas que no tienen ningún tipo de cobertura en salud. Por un lado, puede verse que el porcentaje de niños/as sin cobertura es mayor a medida que aumenta el tramo de edad considerado, en particular, hasta 2010. A su vez, se observa una disminunción marcada de los niños/as sin cobertura de salud para los tres tramos de edad considerados a lo largo del período, llegando a niveles menores al 1% a partir de 2013. En el segundo semestre de 2021, el valor del indicador se ubica levamente por encima del 1%.  

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 563,]
#periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- 1991
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Porcentaje de niños entre 0 y 17 años sin cobertura de salud**
##### País urbano, `r periodo_formatted`
</div>
### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de niños menores de 5 años sin cobertura de salud"|
NOMINDICADOR=="Porcentaje de niños entre 6 y 12 años sin cobertura de salud"|
NOMINDICADOR=="Porcentaje de niños entre 13 y 17 años sin cobertura de salud", URBANORURALUY == "Urbano (más de 5.000 habitantes)", FECHA>1990, SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Porcentaje de niños menores de 5 años sin cobertura de salud" ~ "Entre 0 y 5 años",
NOMINDICADOR=="Porcentaje de niños entre 6 y 12 años sin cobertura de salud" ~ "Entre 6 y 12 años",
NOMINDICADOR=="Porcentaje de niños entre 13 y 17 años sin cobertura de salud" ~ "Entre 13 y 17 años"))  %>%
    mutate(UNIDAD = factor(UNIDAD, levels = c("Entre 0 y 5 años", "Entre 6 y 12 años", "Entre 13 y 17 años")))  %>%
ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 6, color = UNIDAD))+
  scale_color_manual(
    values = c("darkorange", 639,"#a1dd70","darkseagreen3")) +
  ylim(0, 15) +
  scale_x_continuous(breaks=seq(1991, max, 2), limits=c(1991,max))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Porcentaje de niños menores de 5 años sin cobertura de salud"|
NOMINDICADOR=="Porcentaje de niños entre 6 y 12 años sin cobertura de salud"|
NOMINDICADOR=="Porcentaje de niños entre 13 y 17 años sin cobertura de salud", URBANORURALUY == "Urbano (más de 5.000 habitantes)", FECHA>1990, SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR))*100,1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Porcentaje de niños menores de 5 años sin cobertura de salud" ~ "Entre 0 y 5 años",
NOMINDICADOR=="Porcentaje de niños entre 6 y 12 años sin cobertura de salud" ~ "Entre 6 y 12 años",
NOMINDICADOR=="Porcentaje de niños entre 13 y 17 años sin cobertura de salud" ~ "Entre 13 y 17 años"))  %>%
    mutate(UNIDAD = factor(UNIDAD, levels = c("Entre 0 y 5 años", "Entre 6 y 12 años", "Entre 13 y 17 años")))  %>%
  rename(ANIO = FECHA)  %>%
  rename(TRAMO_EDAD=UNIDAD)
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "TRAMO_EDAD", "ANIO","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 563,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`

#### Código en R

```{r, echo=TRUE, eval=FALSE}

### Estimación de valores 2021 ###

# Para sintaxix de años anteriores consultar: 
# https://osf.io/dyzg8/files/osfstorage#

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de paquetes ###

# Instalar si es necesario:
#install.packages("rio")
#install.packages("srvyr")
#install.packages("tidyverse")

library(rio)
library(srvyr)
library(tidyverse)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Descarga bases ECH 2021 (INE) de repositorio UMAD-FCS ###

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65232781fc021200aab6", 
#  destfile = "ECH2021_sem1.Rdata"
#)

#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65616946a002027a4652", 
#  destfile = "ECH2021_sem2_implant.Rdata"
#)


#download.file(
#  url = "https://osf.io/dyzg8/files/osfstorage/63da65276946a001fe7a4630", 
#  destfile = "ECH2021_sem2_panel.Rdata"
#)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Carga de bases ###

#load("ECH2021_sem1.Rdata")
#sem1 <- x
#load("ECH2021_sem2_implant.Rdata")
#sem2_implant <- x

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Me quedo con los hogares donde hay uno y solo un jefe
sem1 <- sem1 %>% dplyr::mutate(bc_correlat = numero)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_correlat = ID)


sem1 <- sem1 %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))
sem2_implant <- sem2_implant %>% dplyr::mutate(jefe = case_when(e30==1 ~ 1, e30!=1 ~ 0))

sem1 <- sem1 %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()
sem2_implant <- sem2_implant %>% group_by(bc_correlat) %>% mutate(sumjefe=sum(jefe)) %>% as.data.frame()

sem1 <- sem1 %>%  filter(sumjefe==1)
sem2_implant <- sem2_implant %>%  filter(sumjefe==1)


### Generación de nuevas variables ###

# Renombro edad

sem1 <- sem1 %>% dplyr::mutate(bc_pe3 = E27)
sem2_implant <- sem2_implant %>% dplyr::mutate(bc_pe3 = e27)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Cobertura de salud
sem2_implant <- sem2_implant %>% dplyr::mutate(nocobert=case_when(e45_cv==7 ~ 1, e45_cv!=7 ~ 0)) 

# Región
sem1 <- sem1 %>% dplyr::mutate(bd_region = case_when(region_4 == 1 | region_4 == 2 ~ 1,
                                                     region_4 == 3 ~ 2,
                                                     region_4 == 4 ~ 3))

sem2_implant <- sem2_implant %>% dplyr::mutate(bd_region = case_when(region_4 == 1 | region_4 == 2 ~ 1,
                                                                     region_4 == 3 ~ 2,
                                                                     region_4 == 4 ~ 3))


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
###Ponderador semestral
sem1 <- sem1 %>% dplyr::mutate(pesosem = pesomen/6)
sem2_implant <- sem2_implant %>% dplyr::mutate(pesosem = w_sem)

### Bases a nivel hogar ###                               

sem1_h <- sem1 %>% distinct(numero, .keep_all = TRUE)
sem2_implant_h <- sem2_implant %>% distinct(ID, .keep_all = TRUE)


### Información de muestreo ###

sem1_svy           <- srvyr::as_survey_design(sem1, ids = bc_correlat, weights = pesosem)
sem1_h_svy         <- srvyr::as_survey_design(sem1_h, ids = bc_correlat, weights = pesosem)

sem2_implant_svy <- srvyr::as_survey_design(sem2_implant, ids = ID, weights = pesosem)
sem2_implant_h_svy <- srvyr::as_survey_design(sem2_implant_h, ids = ID, weights = pesosem)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### Estimación de indicadores 2021 ###


### Porcentaje de niños entre 0 y 17 años sin cobertura de salud

## Entre 0 y 5

b_sem <- sem2_implant_svy %>%
  filter(bd_region == 1 & bc_pe3< 6) %>%
  srvyr::summarise(colname = srvyr::survey_mean(nocobert))
b_sem_0a6 <- as.numeric(b_sem$colname)

##Entre 6 y 12

b_sem <- sem2_implant_svy %>%
  filter(bd_region == 1 & bc_pe3> 5 & bc_pe3<13) %>%
  srvyr::summarise(colname = srvyr::survey_mean(nocobert))
b_sem_6a12 <- as.numeric(b_sem$colname)

##Entre 13 y 17

b_sem <- sem2_implant_svy %>%
  filter(bd_region == 1 & bc_pe3> 12 & bc_pe3<18) %>%
  srvyr::summarise(colname = srvyr::survey_mean(nocobert))
b_sem_13a17 <- as.numeric(b_sem$colname)



c_ano <- cbind(b_sem_0a6, b_sem_6a12, b_sem_13a17)

rownames(c_ano) <-    c("Sin cobertura de salud")
colnames(c_ano)<- c("Entre 0 y 5","Entre 6 y 12", "Entre 13 y 17")
estimacion2021 <- c_ano

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #


```

## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 

```{r}
nota <- strsplit(paste0("Notas: ", ficha [1,"NOTAS"])," ")[[1]]
nota_formatted <- paste(
  text_spec(nota, color = 1, font_size = 12, align =  2),
  collapse = " ")
```
`r nota_formatted`

<br />

## **Mortalidad**

<div style="text-align: justify">
El siguiente indicador da cuenta de la cantidad de defunciones de menores de 1 año y menores de 5 años cada 1000 habitantes. Es posible observar que desde 1984 hasta 2021 ambas tasas se han reducido sustancialmente. La tasa de mortalidad para niños/as menores de 1 año pasa de 30,1 a 6,3 en el período considerado, mientras la tasa de mortalidad para niños/as menores de 5 años pasa de 34,1 a 7,5. 

</div>

<br />
<div style="text-align: center">

```{r}
periodo <- base[base$CODIND == 564,]
periodo <- periodo[periodo$URBANORURALUY == "Total país",]
max<- max(periodo$FECHA)
min<- min(periodo$FECHA)
periodo <- c(min," - ", max)
periodo_formatted <- paste(
  text_spec(periodo, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
##### **Tasa de mortalidad infantil (menores de 1 año y de 5 años)**
##### Total país, `r periodo_formatted`
</div>
### {.tabset .tabset-fade .tabset-pills}
#### Gráfico




```{r, out.width='100%'}
#===============================================================================
g1 <- 
  base %>% filter(NOMINDICADOR=="Tasa de mortalidad infantil (menor a 1 año)"|
NOMINDICADOR=="Tasa de mortalidad infantil (menor a 5 años)", URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR)),1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Tasa de mortalidad infantil (menor a 1 año)" ~ "Menor de 1 año",
NOMINDICADOR=="Tasa de mortalidad infantil (menor a 5 años)" ~ "Menor de 5 años"))  %>%
    mutate(UNIDAD = factor(UNIDAD, levels = c("Menor de 1 año", "Menor de 5 años")))  %>%
ggplot(aes(x = FECHA, y = VALOR)) +
  geom_line(aes(group = 2, color = UNIDAD))+
  scale_color_manual(
    values = c("darkorange", 639)) +
  ylim(0, 40) +
  scale_x_continuous(breaks=seq(1984, 2022, 2), limits=c(1984,2022))  +
  theme_minimal() +
  labs(
    color = "",
    title = "",
    caption = "Unidad de Métodos y Acceso a Datos (UMAD)",
    x = "",
    y = ""
  )
ggplotly(g1) %>% 
  config(displayModeBar = F) %>%
  layout(margin = list(b = 100), legend = list(x = 0.5, y = -0.1,orientation = "h", xanchor = "center" )) 

#===============================================================================
```

#### Tabla


```{r}
t1 <- 
  base %>% filter(NOMINDICADOR=="Tasa de mortalidad infantil (menor a 1 año)"|
NOMINDICADOR=="Tasa de mortalidad infantil (menor a 5 años)", URBANORURALUY == "Total país", SEXO == "Todos", ASCENDENCIA == "Todos", QUINTIL== "Todos", EDAD=="Todos", POBRE=="Todos") %>%
  mutate(VALOR = round((as.numeric(VALOR)),1)) %>% 
  mutate(UNIDAD = case_when(NOMINDICADOR=="Tasa de mortalidad infantil (menor a 1 año)" ~ "Menor de 1 año",
NOMINDICADOR=="Tasa de mortalidad infantil (menor a 5 años)" ~ "Menor de 5 años"))  %>%
    mutate(UNIDAD = factor(UNIDAD, levels = c("Menor de 1 año", "Menor de 5 años")))  %>%
  rename(ANIO = FECHA)  %>%
  rename(EDAD_ant=EDAD) %>%
  rename(EDAD=UNIDAD)
t1 <- t1 [,c("NOMINDICADOR","PAÍS", "EDAD", "ANIO","VALOR")]


DT::datatable(t1, extensions =  'Buttons', options =  list(dom = 'Bfrtip',
                                                       buttons = c('copy', 'csv', 'excel', 'print') )
) 
```


#### Ficha Técnica


```{r}
ficha = base_fichas[base_fichas$CODIND == 564,]

def <- strsplit(paste0(ficha [1,"DEFINICIÓN"])," ")[[1]]
def_formatted <- paste(
  text_spec(def, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Definición:** `r def_formatted`


```{r}
calc <- strsplit(paste0(ficha [1,"FORMA DE CÁLCULO"])," ")[[1]]
calc_formatted <- paste(
  text_spec(calc, color = 1, font_size = 16, align = "justify"),
  collapse = " ")
```
> **Forma de cálculo:** `r calc_formatted`


## {.toc-ignore .unlisted .unnumbered}



```{r}
cita <- strsplit(paste0("Fuente: ", ficha [1,"FUENTE"])," ")[[1]]
cita_formatted <- paste(
  text_spec(cita, color = 1, font_size = 12, align = 2),
  collapse = " ")
```
`r cita_formatted` 


<br />
<br />



# **Referencias**
## **Contacto**	

Si tiene consultas, sugerencias, comentarios o encontró algún error en este documento, le agradecemos que se contacte con nosotros/as.

**Contacto: umad@cienciassociales.edu.uy**